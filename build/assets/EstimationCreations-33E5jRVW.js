import{r as B,a6 as jt,aj as yt,V as gt,j as t}from"./index-DprkEiEK.js";import{F as ft,a as s}from"./FormItem-CLbUnAko.js";import{B as F}from"./Button-PtpZLnju.js";import{S as xt}from"./StickyFooter-cFt-E6ev.js";import{F as Dt,a as Ct,b as u,c as W}from"./formik.esm-PmOj15rT.js";import{c as L,e as I,d as V,a as U,f as R,g as $}from"./index.esm-DuwqUL2u.js";import{t as z,N as T}from"./toast-6mWVT1dx.js";import{A as Q}from"./AdaptableCard-39f9t030.js";import{I as m}from"./Input-D9aAsaRn.js";import{Y as G,Z as H}from"./index-DRT6ZEuo.js";import{D as Y}from"./index-DVa3s2tW.js";import{S as qt}from"./Select-Bn_1dfRU.js";import{f as At,e as vt,c as kt}from"./api-DSJmtioL.js";import"./index-D-ApMVAy.js";import"./proxy-LJQ4uuy1.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BW0HCES2.js";import"./StatusIcon-BF-FCtRa.js";import"./CloseButton-DD9EgaVn.js";import"./chainedFunction-BxZSneMW.js";import"./Card-BpjZUxOM.js";import"./Views-BMPEAoNT.js";import"./isNil-DH5bwM4B.js";import"./get-Zx5oz8JG.js";import"./toString-Chg3pnU2.js";import"./useControllableState-BZtcuTBt.js";import"./floating-ui.react-svs4PfWS.js";import"./floating-ui.dom-D1IisfOw.js";import"./Calendar-DUSHLq6D.js";import"./useUniqueId-BPFxATym.js";const Et=L().shape({dateOfEstimation:I().required("Estimation Date is required"),workStartDate:I().required("Work Start Date is required").min(V("dateOfEstimation"),"Work Start Date cannot be before Estimation Date"),workEndDate:I().required("Work End Date is required").min(V("workStartDate"),"Work End Date cannot be before Work Start Date"),validUntil:I().required("Valid Until Date is required").min(V("dateOfEstimation"),"Valid Until Date cannot be before Estimation Date"),paymentDueBy:U().required("Payment Due is required"),status:U().required("Status is required"),subject:U().required("subject is required"),materials:R().of(L().shape({description:U().required("Material name is required"),uom:U().required("Unit of measurement is required"),quantity:$().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:$().required("Unit price is required").min(0,"Unit price must be positive")})),labourCharges:R().of(L().shape({designation:U().required("Designation is required"),days:$().required("Days is required").min(0,"Days must be positive"),price:$().required("Price is required").min(0,"Price must be positive")})),termsAndConditions:R().of(L().shape({description:U().required("Description is required"),quantity:$().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:$().required("Unit price is required").min(0,"Unit price must be positive")}))}),it=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],wt=B.forwardRef((nt,rt)=>{const{onDiscard:ot}=nt,st=jt(),_=yt();gt(),console.log("paramsData",_);const{projectId:lt,estimationId:b}=_,[mt,dt]=B.useState({dateOfEstimation:new Date,workStartDate:new Date,workEndDate:new Date(Date.now()+7*24*60*60*1e3),validUntil:new Date(Date.now()+30*24*60*60*1e3),paymentDueBy:"",status:"Draft",materials:[{description:"",uom:"",quantity:0,unitPrice:0,total:0}],labourCharges:[{designation:"",days:0,price:0,total:0}],termsAndConditions:[{description:"",quantity:0,unitPrice:0,total:0}],estimatedAmount:0,subject:""}),[ct,ut]=B.useState(!!b);B.useEffect(()=>{(async()=>{if(b)try{const i=(await At(b)).data;dt({dateOfEstimation:new Date(i.createdAt),workStartDate:new Date(i.workStartDate),workEndDate:new Date(i.workEndDate),validUntil:new Date(i.validUntil),paymentDueBy:i.paymentDueBy.toString(),status:i.status||"Draft",materials:i.materials.map(d=>({description:d.description,uom:d.uom,quantity:d.quantity,unitPrice:d.unitPrice,total:d.total})),labourCharges:i.labour.map(d=>({designation:d.designation,days:d.days,price:d.price,total:d.total})),termsAndConditions:i.termsAndConditions.map(d=>({description:d.description,quantity:d.quantity,unitPrice:d.unitPrice,total:d.total})),estimatedAmount:i.estimatedAmount,quotationAmount:i.quotationAmount,commissionAmount:i.commissionAmount,profit:i.profit,project:i.project._id,subject:i==null?void 0:i.subject})}catch(o){console.error("Error fetching estimation:",o),z.push(t.jsx(T,{title:"Error",type:"danger",duration:2500,children:"Failed to load estimation data."}),{placement:"top-center"})}finally{ut(!1)}})()},[b]);const pt=async e=>{try{b?(await vt(b,{project:e.project,paymentDueBy:e.paymentDueBy,termsAndConditions:e.termsAndConditions,validUntil:e.validUntil,materials:e.materials,labour:e.labourCharges,workEndDate:e.workEndDate,workStartDate:e.workStartDate,commissionAmount:e.commissionAmount,quotationAmount:e.quotationAmount,status:e.status,subject:e.subject}),z.push(t.jsx(T,{title:"Estimation Updated",type:"success",duration:2500,children:"Estimation updated successfully."}),{placement:"top-center"})):(await kt({project:lt,paymentDueBy:e.paymentDueBy,termsAndConditions:e.termsAndConditions,validUntil:e.validUntil,materials:e.materials,labour:e.labourCharges,workEndDate:e.workEndDate,workStartDate:e.workStartDate,commissionAmount:e.commissionAmount,quotationAmount:e.quotationAmount,subject:e.subject}),z.push(t.jsx(T,{title:"Estimation Created",type:"success",duration:2500,children:"Estimation created successfully."}),{placement:"top-center"})),st(-1)}catch(o){console.error(`Error ${b?"updating":"creating"} estimation:`,o),(o==null?void 0:o.status)===400?z.push(t.jsx(T,{title:`Not ${b?"Updated":"Created"}`,type:"danger",duration:2500,children:b?"Failed to update estimation":"Only one estimation is allowed per project."}),{placement:"top-center"}):z.push(t.jsxs(T,{title:"Error",type:"danger",duration:2500,children:["Failed to ",b?"update":"create"," estimation. Please try again."]}),{placement:"top-center"})}};return ct?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):t.jsx(Dt,{innerRef:rt,initialValues:mt,validationSchema:Et,onSubmit:pt,enableReinitialize:!0,children:({values:e,touched:o,errors:i,isSubmitting:d,setFieldValue:M,handleChange:ht})=>{B.useEffect(()=>{e.materials.forEach((n,r)=>{const c=parseFloat((n.quantity*n.unitPrice).toFixed(2));n.total!==c&&M(`materials[${r}].total`,c)}),e.labourCharges.forEach((n,r)=>{const c=parseFloat((n.days*n.price).toFixed(2));n.total!==c&&M(`labourCharges[${r}].total`,c)}),e.termsAndConditions.forEach((n,r)=>{const c=parseFloat((n.quantity*n.unitPrice).toFixed(2));n.total!==c&&M(`termsAndConditions[${r}].total`,c)});const l=e.materials.reduce((n,r)=>n+r.quantity*r.unitPrice,0),p=e.labourCharges.reduce((n,r)=>n+r.days*r.price,0),h=e.termsAndConditions.reduce((n,r)=>n+r.quantity*r.unitPrice,0),a=parseFloat((l+p+h).toFixed(2));if(e.estimatedAmount!==a&&M("estimatedAmount",a),e.quotationAmount!==void 0&&e.commissionAmount!==void 0){const n=parseFloat((e.quotationAmount-a-e.commissionAmount).toFixed(2));e.profit!==n&&M("profit",n)}},[e.materials,e.labourCharges,e.termsAndConditions,e.quotationAmount,e.commissionAmount]);const j=l=>{ht(l);const{name:p,value:h}=l.target;M(p,parseFloat(h)||0)};return t.jsx(Ct,{children:t.jsxs(ft,{children:[t.jsxs(Q,{divider:!0,className:"mb-4",children:[t.jsx("h5",{children:"Work Details"}),t.jsx("p",{className:"mb-6",children:"Section to configure client and work information"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsx(s,{label:"Work Start Date *",invalid:!!i.workStartDate&&o.workStartDate,errorMessage:i.workStartDate,children:t.jsx(u,{name:"workStartDate",children:({field:l,form:p})=>t.jsx(Y,{placeholder:"Select date",value:l.value,onChange:h=>{p.setFieldValue(l.name,h)},minDate:e.dateOfEstimation})})}),t.jsx(s,{label:"Work End Date *",invalid:!!i.workEndDate&&o.workEndDate,errorMessage:i.workEndDate,children:t.jsx(u,{name:"workEndDate",children:({field:l,form:p})=>t.jsx(Y,{placeholder:"Select date",value:l.value,onChange:h=>{p.setFieldValue(l.name,h)},minDate:e.workStartDate})})}),t.jsx(s,{label:"Valid Until *",invalid:!!i.validUntil&&o.validUntil,errorMessage:i.validUntil,children:t.jsx(u,{name:"validUntil",children:({field:l,form:p})=>t.jsx(Y,{placeholder:"Select date",value:l.value,onChange:h=>{p.setFieldValue(l.name,h)},minDate:e.dateOfEstimation})})}),t.jsx(s,{label:"Payment Due By *",invalid:!!i.paymentDueBy&&o.paymentDueBy,errorMessage:i.paymentDueBy,children:t.jsx(u,{type:"number",name:"paymentDueBy",placeholder:"paymentDueBy",component:m})})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.jsx(s,{label:"Subject",children:t.jsx(u,{type:"text",name:"subject",value:e.subject,placeholder:"Subject",textArea:!0,component:m})})})]}),t.jsxs(Q,{divider:!0,className:"mb-4",children:[t.jsx("h5",{children:"Materials"}),t.jsx("p",{className:"mb-6",children:"List of materials required for the project"}),t.jsx(W,{name:"materials",children:({push:l,remove:p})=>t.jsxs("div",{className:"space-y-4",children:[e.materials.map((h,a)=>{var n,r,c,y,g,f,x,D,C,q,A,v,k,E,w,P,S,N,K,Z,J,X,tt,et;return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[t.jsx(s,{label:`Material ${a+1}`,invalid:!!((r=(n=i.materials)==null?void 0:n[a])!=null&&r.description)&&((y=(c=o.materials)==null?void 0:c[a])==null?void 0:y.description),errorMessage:(f=(g=i.materials)==null?void 0:g[a])==null?void 0:f.description,children:t.jsx(u,{type:"text",name:`materials[${a}].description`,placeholder:"Material name",component:m})}),t.jsx(s,{label:"UOM",invalid:!!((D=(x=i.materials)==null?void 0:x[a])!=null&&D.uom)&&((q=(C=o.materials)==null?void 0:C[a])==null?void 0:q.uom),errorMessage:(v=(A=i.materials)==null?void 0:A[a])==null?void 0:v.uom,children:t.jsx(u,{name:`materials[${a}].uom`,children:({field:at,form:bt})=>t.jsx(qt,{options:it,value:it.find(O=>O.value===at.value)||null,onChange:O=>{bt.setFieldValue(at.name,(O==null?void 0:O.value)||"")},placeholder:"Select unit"})})}),t.jsx(s,{label:"Quantity",invalid:!!((E=(k=i.materials)==null?void 0:k[a])!=null&&E.quantity)&&((P=(w=o.materials)==null?void 0:w[a])==null?void 0:P.quantity),errorMessage:(N=(S=i.materials)==null?void 0:S[a])==null?void 0:N.quantity,children:t.jsx(u,{type:"number",name:`materials[${a}].quantity`,placeholder:"Quantity",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Unit Price",invalid:!!((Z=(K=i.materials)==null?void 0:K[a])!=null&&Z.unitPrice)&&((X=(J=o.materials)==null?void 0:J[a])==null?void 0:X.unitPrice),errorMessage:(et=(tt=i.materials)==null?void 0:tt[a])==null?void 0:et.unitPrice,children:t.jsx(u,{type:"number",name:`materials[${a}].unitPrice`,placeholder:"Unit price",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Total",children:t.jsx(m,{readOnly:!0,value:h.total,placeholder:"Total"})}),t.jsx("div",{className:"flex justify-end",children:e.materials.length>1&&t.jsx(F,{type:"button",size:"sm",variant:"plain",color:"red",icon:t.jsx(G,{}),onClick:()=>p(a)})})]},a)}),t.jsx(F,{type:"button",size:"sm",variant:"twoTone",icon:t.jsx(H,{}),onClick:()=>l({description:"",quantity:0,unitPrice:0,total:0}),children:"Add Material"})]})})]}),t.jsxs(Q,{divider:!0,className:"mb-4",children:[t.jsx("h5",{children:"Labour Charges"}),t.jsx("p",{className:"mb-6",children:"List of labour charges for the project"}),t.jsx(W,{name:"labourCharges",children:({push:l,remove:p})=>t.jsxs("div",{className:"space-y-4",children:[e.labourCharges.map((h,a)=>{var n,r,c,y,g,f,x,D,C,q,A,v,k,E,w,P,S,N;return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[t.jsx(s,{label:`Designation ${a+1}`,invalid:!!((r=(n=i.labourCharges)==null?void 0:n[a])!=null&&r.designation)&&((y=(c=o.labourCharges)==null?void 0:c[a])==null?void 0:y.designation),errorMessage:(f=(g=i.labourCharges)==null?void 0:g[a])==null?void 0:f.designation,children:t.jsx(u,{type:"text",name:`labourCharges[${a}].designation`,placeholder:"Designation",component:m})}),t.jsx(s,{label:"Days",invalid:!!((D=(x=i.labourCharges)==null?void 0:x[a])!=null&&D.days)&&((q=(C=o.labourCharges)==null?void 0:C[a])==null?void 0:q.days),errorMessage:(v=(A=i.labourCharges)==null?void 0:A[a])==null?void 0:v.days,children:t.jsx(u,{type:"number",name:`labourCharges[${a}].days`,placeholder:"Days",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Price",invalid:!!((E=(k=i.labourCharges)==null?void 0:k[a])!=null&&E.price)&&((P=(w=o.labourCharges)==null?void 0:w[a])==null?void 0:P.price),errorMessage:(N=(S=i.labourCharges)==null?void 0:S[a])==null?void 0:N.price,children:t.jsx(u,{type:"number",name:`labourCharges[${a}].price`,placeholder:"Price per day",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Total",children:t.jsx(m,{readOnly:!0,value:h.total,placeholder:"Total"})}),t.jsx("div",{className:"flex justify-end",children:e.labourCharges.length>1&&t.jsx(F,{type:"button",size:"sm",variant:"plain",color:"red",icon:t.jsx(G,{}),onClick:()=>p(a)})})]},a)}),t.jsx(F,{type:"button",size:"sm",variant:"twoTone",icon:t.jsx(H,{}),onClick:()=>l({designation:"",days:0,price:0,total:0}),children:"Add Labour Charge"})]})})]}),t.jsxs(Q,{divider:!0,className:"mb-4",children:[t.jsx("h5",{children:"Terms & Conditions"}),t.jsx("p",{className:"mb-6",children:"Additional terms and conditions for the project"}),t.jsx(W,{name:"termsAndConditions",children:({push:l,remove:p})=>t.jsxs("div",{className:"space-y-4",children:[e.termsAndConditions.map((h,a)=>{var n,r,c,y,g,f,x,D,C,q,A,v,k,E,w,P,S,N;return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-b pb-4",children:[t.jsx(s,{label:`Description ${a+1}`,invalid:!!((r=(n=i.termsAndConditions)==null?void 0:n[a])!=null&&r.description)&&((y=(c=o.termsAndConditions)==null?void 0:c[a])==null?void 0:y.description),errorMessage:(f=(g=i.termsAndConditions)==null?void 0:g[a])==null?void 0:f.description,children:t.jsx(u,{type:"text",name:`termsAndConditions[${a}].description`,placeholder:"Description",component:m})}),t.jsx(s,{label:"Quantity",invalid:!!((D=(x=i.termsAndConditions)==null?void 0:x[a])!=null&&D.quantity)&&((q=(C=o.termsAndConditions)==null?void 0:C[a])==null?void 0:q.quantity),errorMessage:(v=(A=i.termsAndConditions)==null?void 0:A[a])==null?void 0:v.quantity,children:t.jsx(u,{type:"number",name:`termsAndConditions[${a}].quantity`,placeholder:"Quantity",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Unit Price",invalid:!!((E=(k=i.termsAndConditions)==null?void 0:k[a])!=null&&E.unitPrice)&&((P=(w=o.termsAndConditions)==null?void 0:w[a])==null?void 0:P.unitPrice),errorMessage:(N=(S=i.termsAndConditions)==null?void 0:S[a])==null?void 0:N.unitPrice,children:t.jsx(u,{type:"number",name:`termsAndConditions[${a}].unitPrice`,placeholder:"Unit price",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Total",children:t.jsx(m,{readOnly:!0,value:h.total,placeholder:"Total"})}),t.jsx("div",{className:"flex justify-end",children:e.termsAndConditions.length>1&&t.jsx(F,{type:"button",size:"sm",variant:"plain",color:"red",icon:t.jsx(G,{}),onClick:()=>p(a)})})]},a)}),t.jsx(F,{type:"button",size:"sm",variant:"twoTone",icon:t.jsx(H,{}),onClick:()=>l({description:"",quantity:0,unitPrice:0,total:0}),children:"Add Term"})]})})]}),t.jsxs(Q,{divider:!0,className:"mb-4",children:[t.jsx("h5",{children:"Summary"}),t.jsx("p",{className:"mb-6",children:"Final amounts and approvals"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[t.jsx(s,{label:"Estimated Amount",children:t.jsx(m,{readOnly:!0,name:"estimatedAmount",value:e.estimatedAmount,placeholder:"Estimated amount"})}),t.jsx(s,{label:"Quotation Amount (Optional)",children:t.jsx(u,{type:"number",name:"quotationAmount",placeholder:"Quotation amount",component:m,min:0,onChange:j})}),t.jsx(s,{label:"Commission Amount (Optional)",children:t.jsx(u,{type:"number",name:"commissionAmount",placeholder:"Commission amount",component:m,min:0,onChange:j})}),e.quotationAmount!==void 0&&e.commissionAmount!==void 0&&t.jsx(s,{label:"Profit",children:t.jsx(m,{readOnly:!0,name:"profit",value:e.profit||0,placeholder:"Profit"})})]})]}),t.jsxs(xt,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[t.jsx("div",{children:t.jsx(F,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ot,children:"Discard"})}),t.jsxs("div",{className:"md:flex grid-2 gap-2",children:[t.jsx("div",{className:"md:flex "}),t.jsx("div",{className:"md:flex",children:t.jsx(F,{size:"sm",variant:"solid",loading:d,type:"submit",children:b?"Update Estimation":"Create Estimation"})})]})]})]})})}})});wt.displayName="EstimationForm";export{wt as default};
