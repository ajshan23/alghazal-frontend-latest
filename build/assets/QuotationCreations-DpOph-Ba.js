import{r as f,a6 as Ae,aj as Pe,V as we,j as e}from"./index-DILgqWJA.js";import{F as qe,a as c}from"./FormItem-B3r3kvbj.js";import{B as A}from"./Button-CrFFb1HK.js";import{S as Ce}from"./StickyFooter-CNIxLGaB.js";import{F as Fe,a as Ne,c as ie,b as j}from"./formik.esm-C25U-yEa.js";import{c as ne,e as ke,f as re,a as $,g as z}from"./index.esm-Bxz8Ut03.js";import{t as k,N as T}from"./toast-C21ZMU7w.js";import{A as I}from"./AdaptableCard-1Ir31AKW.js";import{I as u}from"./Input-Dxk0DyPZ.js";import{Y as se,Z as oe}from"./index-CkmhLFFZ.js";import{S as le}from"./Select-MW_nRzI-.js";import{g as Te,u as Ie,c as Se}from"./api-DaxB1_FG.js";import"./index-BJIBRJLK.js";import"./proxy-CGHHffYX.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-xIXYbZ5s.js";import"./StatusIcon-CveerTQG.js";import"./CloseButton-B_sCjbKz.js";import"./chainedFunction-BxZSneMW.js";import"./Card-w1_DiXgz.js";import"./Views-Bort5Yyy.js";import"./isNil-Do1TtN__.js";import"./get-B6fDZCrK.js";import"./toString-ZniEQAva.js";import"./floating-ui.dom-D1IisfOw.js";const ce=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],me=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],ue=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],Qe=ne().shape({validUntil:ke().required("Valid Until date is required"),items:re().of(ne().shape({description:$().required("Description is required"),uom:$().required("Unit of measurement is required"),quantity:z().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:z().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:re().of($().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:z().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),$e=f.forwardRef((de,pe)=>{const{onDiscard:ge}=de,he=Ae(),{projectId:S}=Pe(),{state:y}=we(),be=y==null?void 0:y.estimationId,d=y==null?void 0:y.quotationId,[ve,fe]=f.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:S,estimation:be}),[je,ye]=f.useState(!!d),[C,F]=f.useState([]),[x,Q]=f.useState({});f.useEffect(()=>{(async()=>{if(d)try{const a=await Te(S),n={},v=[];a.items.forEach((r,o)=>{var l;(l=r.image)!=null&&l.url&&(n[o]=r.image.url),v[o]=null}),Q(n),F(v),fe({_id:a._id,quotationNumber:a.quotationNumber,date:new Date(a.date),validUntil:new Date(a.validUntil),items:a.items.map(r=>({description:r.description,uom:r.uom,quantity:r.quantity,unitPrice:r.unitPrice,totalPrice:r.totalPrice,image:r.image})),termsAndConditions:a.termsAndConditions.length>0?a.termsAndConditions:[""],vatPercentage:a.vatPercentage,subtotal:a.subtotal,vatAmount:a.vatAmount,netAmount:a.netAmount,project:a.project._id,estimation:a.estimation._id})}catch(a){console.error("Error fetching quotation:",a),k.push(e.jsx(T,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data."}),{placement:"top-center"})}finally{ye(!1)}})()},[d,S]);const xe=async i=>{try{const a=C.filter(n=>n!==null);d?(await Ie(d,{...i,projectId:i.project,estimationId:i.estimation},a),k.push(e.jsx(T,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await Se({...i,projectId:i.project,estimationId:i.estimation},a),k.push(e.jsx(T,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),he(-1)}catch(a){console.error(`Error ${d?"updating":"creating"} quotation:`,a),k.push(e.jsxs(T,{title:"Error",type:"danger",duration:2500,children:["Failed to ",d?"update":"create"," quotation. Please try again."]}),{placement:"top-center"})}},E=(i,a)=>{const n=[...C];if(n[i]=a,F(n),a&&x[i]){const v={...x};delete v[i],Q(v)}};return je?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(Fe,{innerRef:pe,initialValues:ve,validationSchema:Qe,onSubmit:xe,enableReinitialize:!0,children:({values:i,touched:a,errors:n,isSubmitting:v,setFieldValue:r})=>(f.useEffect(()=>{i.items.forEach((t,m)=>{const g=parseFloat((t.quantity*t.unitPrice).toFixed(2));t.totalPrice!==g&&r(`items[${m}].totalPrice`,g)});const o=i.items.reduce((t,m)=>t+m.totalPrice,0);i.subtotal!==o&&r("subtotal",o);const l=parseFloat((o*(i.vatPercentage/100)).toFixed(2)),p=parseFloat((o+l).toFixed(2));i.vatAmount!==l&&r("vatAmount",l),i.netAmount!==p&&r("netAmount",p)},[i.items,i.vatPercentage]),e.jsx(Ne,{children:e.jsxs(qe,{children:[e.jsxs(I,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Details"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4"})]}),e.jsxs(I,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Items"}),e.jsx(ie,{name:"items",children:({push:o,remove:l})=>e.jsxs("div",{className:"space-y-4",children:[i.items.map((p,t)=>{var m,g,P,w,N,h,U,D,O,M,V,L,_,B,R,G,H,Y,K,Z,J,W,X,ee,te,ae;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-b pb-4",children:[e.jsx(c,{label:`Item ${t+1}`,invalid:!!((g=(m=n.items)==null?void 0:m[t])!=null&&g.description)&&((w=(P=a.items)==null?void 0:P[t])==null?void 0:w.description),errorMessage:(h=(N=n.items)==null?void 0:N[t])==null?void 0:h.description,children:e.jsx(j,{as:u,name:`items[${t}].description`,placeholder:"Description",textArea:!0})}),e.jsx(c,{label:"UOM",invalid:!!((D=(U=n.items)==null?void 0:U[t])!=null&&D.uom)&&((M=(O=a.items)==null?void 0:O[t])==null?void 0:M.uom),errorMessage:(L=(V=n.items)==null?void 0:V[t])==null?void 0:L.uom,children:e.jsx(j,{name:`items[${t}].uom`,children:({field:s,form:b})=>e.jsx(le,{options:ce,value:ce.find(q=>q.value===s.value)||null,onChange:q=>{b.setFieldValue(s.name,(q==null?void 0:q.value)||"")},placeholder:"Select unit"})})}),e.jsx(c,{label:"Qty",invalid:!!((B=(_=n.items)==null?void 0:_[t])!=null&&B.quantity)&&((G=(R=a.items)==null?void 0:R[t])==null?void 0:G.quantity),errorMessage:(Y=(H=n.items)==null?void 0:H[t])==null?void 0:Y.quantity,children:e.jsx(j,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:u,min:0,onChange:s=>{const b=parseFloat(s.target.value)||0;r(`items[${t}].quantity`,b)}})}),e.jsx(c,{label:"Unit Price",invalid:!!((Z=(K=n.items)==null?void 0:K[t])!=null&&Z.unitPrice)&&((W=(J=a.items)==null?void 0:J[t])==null?void 0:W.unitPrice),errorMessage:(ee=(X=n.items)==null?void 0:X[t])==null?void 0:ee.unitPrice,children:e.jsx(j,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:u,min:0,onChange:s=>{const b=parseFloat(s.target.value)||0;r(`items[${t}].unitPrice`,b)}})}),e.jsx(c,{label:"Total",children:e.jsx(u,{readOnly:!0,value:(p.quantity*p.unitPrice).toFixed(2),placeholder:"Total"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex justify-end",children:i.items.length>1&&e.jsx(A,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(se,{}),onClick:()=>{l(t);const s=[...C];if(s.splice(t,1),F(s),x[t]){const b={...x};delete b[t],Q(b)}}})}),e.jsx("input",{type:"file",accept:"image/*",onChange:s=>{s.target.files&&s.target.files[0]?E(t,s.target.files[0]):E(t,null)},className:"text-sm"}),(x[t]||((te=p.image)==null?void 0:te.url))&&e.jsx("div",{className:"mt-1",children:e.jsx("img",{src:x[t]||((ae=p.image)==null?void 0:ae.url),alt:"Item",className:"h-10 w-10 object-cover rounded"})})]})]},t)}),e.jsx(A,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(oe,{}),onClick:()=>{o({description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}),F([...C,null])},children:"Add Item"})]})})]}),e.jsxs(I,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx(ie,{name:"termsAndConditions",children:({push:o,remove:l})=>e.jsxs("div",{className:"space-y-4",children:[i.termsAndConditions.map((p,t)=>{var m,g,P;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(c,{className:"flex-grow",invalid:!!((m=n.termsAndConditions)!=null&&m[t])&&((g=a.termsAndConditions)==null?void 0:g[t]),errorMessage:(P=n.termsAndConditions)==null?void 0:P[t],children:t<2?e.jsx(j,{name:`termsAndConditions[${t}]`,children:({field:w,form:N})=>e.jsx(le,{options:t===0?me:ue,value:(t===0?me:ue).find(h=>h.value===w.value)||null,onChange:h=>{N.setFieldValue(w.name,(h==null?void 0:h.value)||"")},placeholder:t===0?"Select work start term":"Select payment term"})}):e.jsx(j,{as:u,name:`termsAndConditions[${t}]`,placeholder:"Additional term or condition"})}),e.jsx(A,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(se,{}),onClick:()=>l(t)})]},t)}),e.jsx(A,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(oe,{}),onClick:()=>o(""),children:"Add Term"})]})})]}),e.jsxs(I,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{label:"Subtotal",children:e.jsx(u,{readOnly:!0,value:i.subtotal.toFixed(2),placeholder:"Subtotal"})}),e.jsx(c,{label:"VAT Percentage",invalid:!!n.vatPercentage&&a.vatPercentage,errorMessage:n.vatPercentage,children:e.jsx(j,{as:u,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100})}),e.jsx(c,{label:"VAT Amount",children:e.jsx(u,{readOnly:!0,value:i.vatAmount.toFixed(2),placeholder:"VAT amount"})}),e.jsx(c,{label:"Net Amount",children:e.jsx(u,{readOnly:!0,value:i.netAmount.toFixed(2),placeholder:"Net amount"})})]})]}),e.jsxs(Ce,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(A,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ge,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(A,{size:"sm",variant:"solid",loading:v,type:"submit",children:d?"Update Quotation":"Create Quotation"})})]})]})}))})});$e.displayName="QuotationForm";export{$e as default};
