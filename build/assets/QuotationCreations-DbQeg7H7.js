import{r as f,a6 as qe,aj as Ae,V as Pe,j as e}from"./index-CBK0URRE.js";import{F as we,a as o}from"./FormItem-cecpDNA8.js";import{B as q}from"./Button-C7RHz5ZO.js";import{S as Ce}from"./StickyFooter-DKP2vOfc.js";import{F as Fe,a as Ne,b as d,c as ie}from"./formik.esm-BA_ugT9w.js";import{c as ne,e as ke,f as re,a as U,g as D}from"./index.esm-CoevhjqU.js";import{t as k,N as S}from"./toast-Jn1rpau0.js";import{A as T}from"./AdaptableCard-DFOm_ZPY.js";import{I as m}from"./Input-CVZjq5Jv.js";import{Y as le,Z as se}from"./index-BXubtGR5.js";import{D as Se}from"./index-apRtoHco.js";import{S as oe}from"./Select-D9cRqVHS.js";import{g as Te,u as Ie,c as Qe}from"./api-Cz_nDTpS.js";import"./index-B_Ah24CK.js";import"./proxy-BwDlMs0o.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-DWYFunET.js";import"./StatusIcon-CeCxbmag.js";import"./CloseButton-D_90GCW0.js";import"./chainedFunction-BxZSneMW.js";import"./Card-DRF7u5X3.js";import"./Views-Dh3IdAxp.js";import"./isNil-Cc0nJDWu.js";import"./get-DAtU_Z2n.js";import"./toString-zTbtfEe6.js";import"./useControllableState-B8shNMsq.js";import"./floating-ui.react-CYZnfMJH.js";import"./floating-ui.dom-D1IisfOw.js";import"./Calendar-AUHmkVIO.js";import"./useUniqueId-DuxEAYhz.js";const ce=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"sq_m",label:"Square Meter (m²)"},{value:"sq_cm",label:"Square Centimeter (cm²)"},{value:"sq_mm",label:"Square Millimeter (mm²)"},{value:"sq_km",label:"Square Kilometer (km²)"},{value:"sq_in",label:"Square Inch (in²)"},{value:"sq_ft",label:"Square Foot (ft²)"},{value:"sq_yd",label:"Square Yard (yd²)"},{value:"acre",label:"Acre"},{value:"hectare",label:"Hectare (ha)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],me=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],ue=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],Ue=ne().shape({validUntil:ke().required("Valid Until date is required"),items:re().of(ne().shape({description:U().required("Description is required"),uom:U().required("Unit of measurement is required"),quantity:D().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:D().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:re().of(U().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:D().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),De=f.forwardRef((de,pe)=>{const{onDiscard:ge}=de,be=qe(),{projectId:I}=Ae(),{state:y}=Pe(),he=y==null?void 0:y.estimationId,g=y==null?void 0:y.quotationId,[ve,je]=f.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:I,estimation:he}),[fe,ye]=f.useState(!!g),[C,F]=f.useState([]),[x,Q]=f.useState({});f.useEffect(()=>{(async()=>{if(g)try{const a=await Te(I),n={},j=[];a.items.forEach((r,l)=>{var c;(c=r.image)!=null&&c.url&&(n[l]=r.image.url),j[l]=null}),Q(n),F(j),je({_id:a._id,quotationNumber:a.quotationNumber,date:new Date(a.date),validUntil:new Date(a.validUntil),items:a.items.map(r=>({description:r.description,uom:r.uom,quantity:r.quantity,unitPrice:r.unitPrice,totalPrice:r.totalPrice,image:r.image})),termsAndConditions:a.termsAndConditions.length>0?a.termsAndConditions:[""],vatPercentage:a.vatPercentage,subtotal:a.subtotal,vatAmount:a.vatAmount,netAmount:a.netAmount,project:a.project._id,estimation:a.estimation._id})}catch(a){console.error("Error fetching quotation:",a),k.push(e.jsx(S,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data."}),{placement:"top-center"})}finally{ye(!1)}})()},[g,I]);const xe=async i=>{try{const a=C.filter(n=>n!==null);g?(await Ie(g,{...i,projectId:i.project,estimationId:i.estimation},a),k.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await Qe({...i,projectId:i.project,estimationId:i.estimation},a),k.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),be(-1)}catch(a){console.error(`Error ${g?"updating":"creating"} quotation:`,a),k.push(e.jsxs(S,{title:"Error",type:"danger",duration:2500,children:["Failed to ",g?"update":"create"," quotation. Please try again."]}),{placement:"top-center"})}},$=(i,a)=>{const n=[...C];if(n[i]=a,F(n),a&&x[i]){const j={...x};delete j[i],Q(j)}};return fe?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(Fe,{innerRef:pe,initialValues:ve,validationSchema:Ue,onSubmit:xe,enableReinitialize:!0,children:({values:i,touched:a,errors:n,isSubmitting:j,setFieldValue:r})=>(f.useEffect(()=>{i.items.forEach((t,p)=>{const b=parseFloat((t.quantity*t.unitPrice).toFixed(2));t.totalPrice!==b&&r(`items[${p}].totalPrice`,b)});const l=i.items.reduce((t,p)=>t+p.totalPrice,0);i.subtotal!==l&&r("subtotal",l);const c=parseFloat((l*(i.vatPercentage/100)).toFixed(2)),u=parseFloat((l+c).toFixed(2));i.vatAmount!==c&&r("vatAmount",c),i.netAmount!==u&&r("netAmount",u)},[i.items,i.vatPercentage]),e.jsx(Ne,{children:e.jsxs(we,{children:[e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(o,{label:"Quotation Number",children:e.jsx(d,{name:"quotationNumber",type:"text",readOnly:!0,component:m})}),e.jsx(o,{label:"Date",children:e.jsx(d,{name:"date",type:"date",readOnly:!0,component:m})}),e.jsx(o,{label:"Valid Until *",invalid:!!n.validUntil&&a.validUntil,errorMessage:n.validUntil,children:e.jsx(d,{name:"validUntil",children:({field:l,form:c})=>e.jsx(Se,{placeholder:"Select date",value:l.value,onChange:u=>{c.setFieldValue(l.name,u)}})})})]})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Items"}),e.jsx(ie,{name:"items",children:({push:l,remove:c})=>e.jsxs("div",{className:"space-y-4",children:[i.items.map((u,t)=>{var p,b,A,P,N,h,z,E,M,O,_,V,L,B,R,H,Y,G,K,Z,J,W,X,ee,te,ae;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-b pb-4",children:[e.jsx(o,{label:`Item ${t+1}`,invalid:!!((b=(p=n.items)==null?void 0:p[t])!=null&&b.description)&&((P=(A=a.items)==null?void 0:A[t])==null?void 0:P.description),errorMessage:(h=(N=n.items)==null?void 0:N[t])==null?void 0:h.description,children:e.jsx(d,{as:m,name:`items[${t}].description`,placeholder:"Description",textArea:!0})}),e.jsx(o,{label:"UOM",invalid:!!((E=(z=n.items)==null?void 0:z[t])!=null&&E.uom)&&((O=(M=a.items)==null?void 0:M[t])==null?void 0:O.uom),errorMessage:(V=(_=n.items)==null?void 0:_[t])==null?void 0:V.uom,children:e.jsx(d,{name:`items[${t}].uom`,children:({field:s,form:v})=>e.jsx(oe,{options:ce,value:ce.find(w=>w.value===s.value)||null,onChange:w=>{v.setFieldValue(s.name,(w==null?void 0:w.value)||"")},placeholder:"Select unit"})})}),e.jsx(o,{label:"Qty",invalid:!!((B=(L=n.items)==null?void 0:L[t])!=null&&B.quantity)&&((H=(R=a.items)==null?void 0:R[t])==null?void 0:H.quantity),errorMessage:(G=(Y=n.items)==null?void 0:Y[t])==null?void 0:G.quantity,children:e.jsx(d,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:m,min:0,step:"any",onChange:s=>{const v=parseFloat(s.target.value)||0;r(`items[${t}].quantity`,v)}})}),e.jsx(o,{label:"Unit Price",invalid:!!((Z=(K=n.items)==null?void 0:K[t])!=null&&Z.unitPrice)&&((W=(J=a.items)==null?void 0:J[t])==null?void 0:W.unitPrice),errorMessage:(ee=(X=n.items)==null?void 0:X[t])==null?void 0:ee.unitPrice,children:e.jsx(d,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:m,min:0,onChange:s=>{const v=parseFloat(s.target.value)||0;r(`items[${t}].unitPrice`,v)}})}),e.jsx(o,{label:"Total",children:e.jsx(m,{readOnly:!0,value:(u.quantity*u.unitPrice).toFixed(2),placeholder:"Total"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex justify-end",children:i.items.length>1&&e.jsx(q,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(le,{}),onClick:()=>{c(t);const s=[...C];if(s.splice(t,1),F(s),x[t]){const v={...x};delete v[t],Q(v)}}})}),e.jsx("input",{type:"file",accept:"image/*",onChange:s=>{s.target.files&&s.target.files[0]?$(t,s.target.files[0]):$(t,null)},className:"text-sm"}),(x[t]||((te=u.image)==null?void 0:te.url))&&e.jsx("div",{className:"mt-1",children:e.jsx("img",{src:x[t]||((ae=u.image)==null?void 0:ae.url),alt:"Item",className:"h-10 w-10 object-cover rounded"})})]})]},t)}),e.jsx(q,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(se,{}),onClick:()=>{l({description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}),F([...C,null])},children:"Add Item"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx(ie,{name:"termsAndConditions",children:({push:l,remove:c})=>e.jsxs("div",{className:"space-y-4",children:[i.termsAndConditions.map((u,t)=>{var p,b,A;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(o,{className:"flex-grow",invalid:!!((p=n.termsAndConditions)!=null&&p[t])&&((b=a.termsAndConditions)==null?void 0:b[t]),errorMessage:(A=n.termsAndConditions)==null?void 0:A[t],children:t<2?e.jsx(d,{name:`termsAndConditions[${t}]`,children:({field:P,form:N})=>e.jsx(oe,{options:t===0?me:ue,value:(t===0?me:ue).find(h=>h.value===P.value)||null,onChange:h=>{N.setFieldValue(P.name,(h==null?void 0:h.value)||"")},placeholder:t===0?"Select work start term":"Select payment term"})}):e.jsx(d,{as:m,name:`termsAndConditions[${t}]`,placeholder:"Additional term or condition"})}),e.jsx(q,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(le,{}),onClick:()=>c(t)})]},t)}),e.jsx(q,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(se,{}),onClick:()=>l(""),children:"Add Term"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(o,{label:"Subtotal",children:e.jsx(m,{readOnly:!0,value:i.subtotal.toFixed(2),placeholder:"Subtotal"})}),e.jsx(o,{label:"VAT Percentage",invalid:!!n.vatPercentage&&a.vatPercentage,errorMessage:n.vatPercentage,children:e.jsx(d,{as:m,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100})}),e.jsx(o,{label:"VAT Amount",children:e.jsx(m,{readOnly:!0,value:i.vatAmount.toFixed(2),placeholder:"VAT amount"})}),e.jsx(o,{label:"Net Amount",children:e.jsx(m,{readOnly:!0,value:i.netAmount.toFixed(2),placeholder:"Net amount"})})]})]}),e.jsxs(Ce,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(q,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ge,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(q,{size:"sm",variant:"solid",loading:j,type:"submit",children:g?"Update Quotation":"Create Quotation"})})]})]})}))})});De.displayName="QuotationForm";export{De as default};
