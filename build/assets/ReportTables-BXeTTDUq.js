import{r,X as K,j as a,v as te}from"./index-3DLZI4eB.js";import{D as re}from"./DataTable-CU1UK92B.js";import{aT as se,aV as oe,O as le,a0 as ne,a5 as ie}from"./index-CwjAikcA.js";import{b as ce}from"./index-B-0wTPkb.js";import{u as pe}from"./useThemeClass-B_GK6Zwz.js";import{u as de}from"./useQuery-Dx8uzGh7.js";import{d as ue}from"./debounce-CRGwQgqv.js";import{I as me}from"./Input-BCKKbbYo.js";import{k as ge,l as he}from"./api-DhT08BlI.js";import{h as M}from"./moment-C5S46NFB.js";import{a as xe,b as be}from"./BillTableTools-Dcy7Jdet.js";const C=[{value:1,label:"January"},{value:2,label:"February"},{value:3,label:"March"},{value:4,label:"April"},{value:5,label:"May"},{value:6,label:"June"},{value:7,label:"July"},{value:8,label:"August"},{value:9,label:"September"},{value:10,label:"October"},{value:11,label:"November"},{value:12,label:"December"}],ye=()=>{const s=new Date().getFullYear();return Array.from({length:10},(m,o)=>({value:s-o,label:(s-o).toString()}))},Y=({row:s,onDeleteClick:m})=>{const{textTheme:o}=pe(),g=te(),y=K().pathname.includes("/adib-report-view")?"adib":"expense",i={adib:"/app/new-adib-report",expense:"/app/new-expense-report"},v=()=>{g("/app/bill-attachments",{state:{data:s==null?void 0:s.attachments},type:"report"})},h=()=>{g(`${i[y]}/${s._id}`)};return a.jsxs("div",{className:"flex text-lg",children:[a.jsx("span",{className:`cursor-pointer p-2 hover:${o}`,onClick:v,children:a.jsx(le,{})}),a.jsx("span",{className:`cursor-pointer p-2 hover:${o}`,onClick:h,children:a.jsx(ne,{})}),a.jsx("span",{className:"cursor-pointer p-2 hover:text-red-500",onClick:()=>m(s),children:a.jsx(ie,{})})]})},Ee=({onDropdownSelect:s})=>{var O,T;const m=r.useRef(null),[o,g]=r.useState(""),[l,y]=r.useState(new Date().getMonth()+1),[i,v]=r.useState(new Date().getFullYear()),[h,N]=r.useState(!1),[c,x]=r.useState({page:1,limit:10}),[P,R]=r.useState(!1),[I,$]=r.useState(null),[H,j]=r.useState(!1),[p,F]=r.useState({startDate:"",endDate:"",category:"",shop:""}),S=K(),d=r.useCallback(()=>S.pathname.includes("/adib-report-view")?"adib":"expense",[S.pathname])(),L=e=>{F(e),x(t=>({...t,page:1}))},{data:u,isLoading:z,error:A,refetch:q}=de({queryKey:["reports",d,c.page,c.limit,o,l,i,p],queryFn:()=>ge({page:c.page,limit:c.limit,search:o,category:p.category,shop:p.shop,month:l,year:i,reportType:d}),keepPreviousData:!0}),B=((O=u==null?void 0:u.data)==null?void 0:O.reports)||[],D=((T=u==null?void 0:u.data)==null?void 0:T.pagination)||{total:0,page:1,limit:10,totalPages:1,hasNextPage:!1,hasPreviousPage:!1},k=r.useMemo(()=>ue(e=>{g(e),x(t=>({...t,page:1}))},500),[]),J=e=>{k(e.target.value)},V=()=>{var e;g(""),y(new Date().getMonth()+1),v(new Date().getFullYear()),F({startDate:"",endDate:"",category:"",shop:""}),x({page:1,limit:10}),(e=m.current)==null||e.resetSorting()},U=async()=>{var e;N(!0);try{const t=await he({page:c.page,limit:c.limit,search:o,category:p.category,shop:p.shop,month:l,year:i,reportType:d,export:!0}),n=((e=t==null?void 0:t.data)==null?void 0:e.reports)||[];if(n.length===0){console.log("No data to export");return}const f=Object.keys(n[0]).join(",")+`
`,w=n.reduce((Z,ee)=>{const ae=Object.values(ee).join(",")+`
`;return Z+ae},f),G=new Blob([w],{type:"text/csv;charset=utf-8;"}),W=URL.createObjectURL(G),b=document.createElement("a");b.href=W,b.setAttribute("download",`reports-${new Date().toISOString()}.csv`),document.body.appendChild(b),b.click(),document.body.removeChild(b),console.log("Data exported successfully")}catch(t){console.error("Export failed:",t)}finally{N(!1)}},E=e=>{$(e),R(!0)},_=r.useMemo(()=>d==="expense"?[{header:"DATE",accessorKey:"reportDate",cell:e=>a.jsx("span",{children:M(e.row.original.reportDate).format("DD MMM YYYY")})},{header:"Description",accessorKey:"description",cell:e=>a.jsx("span",{children:e.row.original.description||"-"})},{header:"Amount",accessorKey:"amount",cell:e=>a.jsx("span",{children:e.row.original.amount.toFixed(2)})},{header:"Remarks",accessorKey:"remarks",cell:e=>a.jsx("span",{children:e.row.original.remarks})},{header:"Action",id:"action",cell:e=>a.jsx(Y,{row:e.row.original,onDeleteClick:E})}]:[{header:"DATE",accessorKey:"reportDate",cell:e=>a.jsx("span",{children:M(e.row.original.reportDate).format("DD MMM YYYY")})},{header:"Amount",accessorKey:"amount",cell:e=>a.jsx("span",{children:e.row.original.amount.toFixed(2)})},{header:"Category",accessorKey:"category",cell:e=>{var t;return a.jsx("span",{children:(t=e.row.original.category)==null?void 0:t.name})}},{header:"Shop",accessorKey:"shop",cell:e=>{var t;return a.jsx("span",{children:(t=e.row.original.shop)==null?void 0:t.shopName})}},{header:"Remarks",accessorKey:"remarks",cell:e=>a.jsx("span",{children:e.row.original.remarks})},{header:"Action",id:"action",cell:e=>a.jsx(Y,{row:e.row.original,onDeleteClick:E})}],[d]),Q=e=>{x(t=>({...t,page:e}))},X=e=>{x({page:1,limit:e})};return r.useEffect(()=>{var t;const e=((t=C.find(n=>n.value===l))==null?void 0:t.label)||"";s(e)},[l,s]),r.useEffect(()=>()=>{k.cancel()},[k]),A?a.jsxs("div",{className:"p-4 text-red-500",children:["Error loading reports: ",A.message]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"mb-4",children:a.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4",children:[a.jsx(me,{placeholder:"Search reports...",onChange:J,className:"w-full md:max-w-md",value:o}),a.jsxs("div",{className:"flex flex-wrap gap-2 items-center w-full md:w-auto",children:[a.jsx("select",{className:"p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700",value:l,onChange:e=>{var f;const t=Number(e.target.value),n=((f=C.find(w=>w.value===t))==null?void 0:f.label)||"";y(t),s(n)},children:C.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))}),a.jsx("select",{className:"p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700",value:i,onChange:e=>v(Number(e.target.value)),children:ye().map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))}),a.jsx("button",{onClick:V,className:"p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",title:"Reset filters",children:a.jsx(se,{size:18})}),a.jsx("button",{onClick:U,disabled:h,className:`p-2 ${h?"text-gray-400":"text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"}`,title:h?"Exporting...":"Export reports",children:a.jsx(oe,{size:18})}),a.jsxs("button",{onClick:()=>j(!0),className:"px-4 py-2 flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:[a.jsx(ce,{size:16}),"Filter"]})]})]})}),a.jsx(re,{ref:m,columns:_,data:B,skeletonAvatarColumns:[0],skeletonAvatarProps:{className:"rounded-md"},loading:z,pagingData:{total:D.total,pageIndex:D.page,pageSize:D.limit},onPaginationChange:Q,onSelectChange:X}),a.jsx(xe,{isOpen:P,onClose:()=>R(!1),bill:I,refetch:q}),a.jsx(be,{isOpen:H,billType:d,onClose:()=>j(!1),onRequestClose:()=>j(!1),onApplyFilters:L,initialFilters:p})]})};export{Ee as R};
