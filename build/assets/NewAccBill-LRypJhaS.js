import{r as h,j as e,v as _,ak as z}from"./index-3DLZI4eB.js";import{N as C,t as E}from"./toast-BKi6XR_M.js";import{F as L,a as f}from"./FormItem-BL-V7KWu.js";import{B as R}from"./Button-C9ww9UOL.js";import{S as J}from"./StickyFooter-BOIaEWjh.js";import{F as H,a as U,b as g}from"./formik.esm-Cif10a7Y.js";import{A as Q}from"./index-DrvqYkYN.js";import{a5 as P}from"./index-CwjAikcA.js";import{c as Y,a as M,g as G}from"./index.esm-DW5bWfqO.js";import"./Alert-BJMUWgWX.js";import"./index-DPb5rspz.js";import"./Badge-B2aEm3Jr.js";import"./Calendar-D9WkR1Rr.js";import"./Card-CF9KcGlH.js";import"./Skeleton-DYaberbX.js";import{D as K}from"./index-ao32mJN_.js";import"./Dialog-Crbi-7-g.js";import"./Drawer-CRdlTkRI.js";import"./index-ZVEP2S7b.js";import"./useUniqueId-DI0oL57o.js";import{I as D}from"./Input-BCKKbbYo.js";import"./index-D7-L48mv.js";import"./index-CeldJ5wE.js";import"./Progress-C0wqBKPQ.js";import"./index-BvIUGnE1.js";import"./ScrollBar-CvhjHryd.js";import"./index-FxzcmWEN.js";import{S as T}from"./Select-DbBYdRQK.js";import"./Upload-BGoPt-4d.js";import"./index-B2vv1dQX.js";import"./Tag-BEvWyzit.js";import"./index-wZuuJ2Y4.js";import{A as O}from"./AdaptableCard-DUhwjOtA.js";import"./Views-CKmk2VLX.js";import"./chart.config-BThG8UO4.js";import{C as W}from"./ConfirmDialog-C61REaHS.js";import"./DataTable-CU1UK92B.js";import"./SvgIcon-7l9PnEWY.js";import"./SegmentItemOption-D9nyfC21.js";import{f as X,h as Z,i as ee,j as te}from"./api-DhT08BlI.js";import{f as ae}from"./format-BzRktsyD.js";import"./StatusIcon-B68Axw2m.js";import"./CloseButton-wNJpnAMz.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-h8u1Q_39.js";import"./context-DV85rUc2.js";import"./index-ejasuVWi.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-DT5H6Lbl.js";import"./floating-ui.react-BR9Qsiv-.js";import"./floating-ui.dom-D1IisfOw.js";import"./useControllableState-P_D4vZ7w.js";import"./_getPrototype-BB9zh0H4.js";import"./index-DpelZirJ.js";import"./index-Chjiymov.js";import"./toString-Cp3uycBW.js";import"./index-lyoTauZ5.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./index-VcVS_xjk.js";import"./index-CgdDCE4T.js";import"./useThemeClass-B_GK6Zwz.js";const oe=new Date,V=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"}],$=h.forwardRef((c,d)=>{const{type:u,initialData:i={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",amount:"",paymentMethod:"",note:"",remarks:"",attachments:[]},onFormSubmit:y,onDiscard:N,onDelete:v}=c,[S,B]=h.useState([]),[A,j]=h.useState(!0),[b,x]=h.useState(i.attachments||[]);h.useEffect(()=>{(async()=>{var n,l;try{j(!0);const w=((l=(n=(await X()).data)==null?void 0:n.shops)==null?void 0:l.map(a=>({label:a.shopName,value:a._id})))||[];B(w)}catch(s){console.error("Failed to fetch shops:",s)}finally{j(!1)}})()},[]),h.useEffect(()=>{i.attachments&&x(i.attachments)},[i.attachments]);const o=Y().shape({date:M().required("Date is required"),shopName:M().required("Shop Name is required"),roomNo:M().required("Room No is required"),paymentMethod:M().required("Payment Method is required"),amount:G().typeError("Amount must be a number").required("Amount is required")}),F=t=>{if(t.target.files&&t.target.files.length>0){const n=Array.from(t.target.files);x(l=>[...l,...n])}},k=t=>{x(n=>n.filter((l,s)=>s!==t))};return e.jsx(H,{innerRef:d,initialValues:{...i,billType:i.billType||"accommodation",date:i.date||new Date().toISOString().split("T")[0],shopName:i.shopName||"",shopId:i.shopId||"",roomNo:i.roomNo||"",paymentMethod:i.paymentMethod||"",note:i.note||"",remarks:i.remarks||"",attachments:i.attachments||[],amount:i.amount??""},validationSchema:o,onSubmit:async(t,{setSubmitting:n,setErrors:l})=>{var w;const s=new FormData;s.append("billType",t.billType),s.append("billDate",t.date),s.append("shopName",t.shopName),t.shopId&&s.append("shop",t.shopId),s.append("roomNo",t.roomNo),s.append("paymentMethod",t.paymentMethod),s.append("amount",t.amount.toString()),t.invoiceNumber&&s.append("invoiceNo",t.invoiceNumber),t.note&&s.append("note",t.note),t.remarks&&s.append("remarks",t.remarks),b.forEach((a,m)=>{a instanceof File?s.append("attachments",a):s.append(`existingAttachments[${m}]`,JSON.stringify(a))});try{await y(s,n)}catch(a){n(!1),(w=a.message)!=null&&w.includes("Shop already exists")&&l({shopName:"This shop already exists"})}},enableReinitialize:!0,children:({values:t,touched:n,errors:l,isSubmitting:s,setFieldValue:w})=>e.jsx(U,{children:e.jsxs(L,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Accommodation Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(f,{label:"Bill Type",children:e.jsx(g,{name:"billType",children:({field:a,form:m})=>e.jsx(T,{options:[{label:"Accommodation",value:"accommodation"}],value:{label:"Accommodation",value:"accommodation"},onChange:r=>m.setFieldValue(a.name,r==null?void 0:r.value),isDisabled:u==="edit"})})}),e.jsx(f,{label:"Bill Date",invalid:!!l.billDate&&n.billDate,children:e.jsx(g,{name:"billDate",children:({field:a,form:m})=>e.jsx(K,{placeholder:"Select bill Date",value:a.value?new Date(a.value):null,maxDate:oe,onChange:r=>m.setFieldValue(a.name,r?ae(new Date(r.getFullYear(),r.getMonth(),r.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(f,{label:"Shop Name",invalid:!!l.shopName&&n.shopName,errorMessage:l.shopName,children:e.jsx(g,{name:"shopName",children:({field:a,form:m})=>{const r=S.find(p=>p.label===a.value)||null;return e.jsx(T,{placeholder:A?"Loading shops...":"Select Shop",options:S,value:r,onChange:p=>{m.setFieldValue(a.name,(p==null?void 0:p.label)||""),m.setFieldValue("shopId",(p==null?void 0:p.value)||"")},loading:A})}})}),e.jsx(f,{label:"Room No",invalid:!!l.roomNo&&n.roomNo,errorMessage:l.roomNo,children:e.jsx(g,{type:"text",autoComplete:"off",name:"roomNo",placeholder:"Room No",component:D})}),e.jsx(f,{label:"Payment Method",invalid:!!l.paymentMethod&&n.paymentMethod,errorMessage:l.paymentMethod,children:e.jsx(g,{name:"paymentMethod",children:({field:a,form:m})=>e.jsx(T,{placeholder:"Select Payment Method",options:V,value:V.find(r=>r.value===t.paymentMethod),onChange:r=>m.setFieldValue(a.name,(r==null?void 0:r.value)||"")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(f,{label:"Invoice Number",children:e.jsx(g,{type:"text",autoComplete:"off",name:"invoiceNumber",placeholder:"Invoice Number",component:D})}),e.jsx(f,{label:"Amount",invalid:!!l.amount&&n.amount,errorMessage:l.amount,children:e.jsx(g,{name:"amount",children:({field:a,form:m})=>e.jsx(D,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:r=>m.setFieldValue(a.name,r.target.value)})})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsx(f,{label:"Note",children:e.jsx(g,{as:"textarea",autoComplete:"off",name:"note",placeholder:"Note",component:D,textArea:!0})})})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(f,{label:"Attachments",children:[e.jsx("input",{type:"file",multiple:!0,onChange:F,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"}),b.length>0&&e.jsx("div",{className:"space-y-2 mt-3",children:b.map((a,m)=>{const r=a instanceof File,p=r?a.name:a.fileName,q=r?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[q?e.jsx("a",{href:q,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:p}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:p}),e.jsx("button",{type:"button",onClick:()=>k(m),className:"text-red-500 hover:text-red-700 ml-2",children:e.jsx(P,{})})]},m)})})]})]}),e.jsxs(O,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(f,{label:"Remarks",children:e.jsx(g,{as:"textarea",autoComplete:"off",name:"remarks",placeholder:"Remarks",component:D,textArea:!0})})]})]})}),e.jsxs(J,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:u==="edit"&&v&&e.jsx(re,{onDelete:v})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(R,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>N==null?void 0:N(),children:"Discard"}),e.jsx(R,{size:"sm",variant:"solid",loading:s,icon:e.jsx(Q,{}),type:"submit",children:"Save"})]})]})]})})})});$.displayName="AccBillForm";const re=({onDelete:c})=>{const[d,u]=h.useState(!1),i=()=>{u(!1),c==null||c(u)},y=()=>{u(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(P,{}),type:"button",onClick:()=>u(!0),children:"Delete"}),e.jsx(W,{isOpen:d,type:"danger",title:"Delete Accommodation Bill",confirmButtonColor:"red-600",onClose:y,onRequestClose:y,onCancel:y,onConfirm:i,children:e.jsx("p",{children:"Are you sure you want to delete this accommodation bill?"})})]})},I={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",paymentMethod:"",amount:"",note:"",remarks:"",attachments:[]},ht=()=>{const c=_(),{id:d}=z(),[u,i]=h.useState(I),[y,N]=h.useState(!!d),[v,S]=h.useState(null);h.useEffect(()=>{if(!d){i(I),N(!1);return}(async()=>{var b,x;try{N(!0);const o=await Z(d);if(!(o!=null&&o.data))throw new Error("Invalid bill data received");i({billType:o.data.billType||"accommodation",date:o.data.date||I.date,shopName:((b=o.data.shop)==null?void 0:b.shopName)||"",roomNo:o.data.roomNo||"",shopId:((x=o.data.shop)==null?void 0:x._id)||"",invoiceNumber:o.data.invoiceNo||"",paymentMethod:o.data.paymentMethod||"",amount:o.data.amount||"",note:o.data.note||"",remarks:o.data.remarks||"",attachments:o.data.attachments||[]}),S(null)}catch(o){console.error("Error fetching bill:",o),S(o.message||"Failed to load bill data"),E.push(e.jsx(C,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:o.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>c("/app/acc-bill-view"),2500)}finally{N(!1)}})()},[d,c]);const B=async(j,b)=>{var x,o,F,k;try{b(!0);const t=d?await ee(d,j):await te(j);if([200,201].includes(t.status))E.push(e.jsxs(C,{title:`Successfully ${d?"updated":"added"} accommodation bill`,type:"success",duration:2500,children:["Accommodation bill ",d?"updated":"added"," successfully"]}),{placement:"top-center"}),c("/app/acc-bill-view");else throw new Error(((o=(x=t==null?void 0:t.response)==null?void 0:x.data)==null?void 0:o.message)||"Unexpected status code")}catch(t){console.error("Error during form submission:",t),E.push(e.jsx(C,{title:`Error ${d?"updating":"adding"} accommodation bill`,type:"danger",duration:2500,children:((k=(F=t==null?void 0:t.response)==null?void 0:F.data)==null?void 0:k.message)||t.message}),{placement:"top-center"})}finally{b(!1)}},A=()=>{JSON.stringify(u)!==JSON.stringify(I)?window.confirm("Are you sure you want to discard changes?")&&c("/app/acc-bill-view"):c("/app/acc-bill-view")};return y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):v?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(C,{title:"Error loading bill",type:"danger",children:v})}):e.jsx($,{type:d?"edit":"new",initialData:u,onFormSubmit:B,onDiscard:A})};export{ht as default};
