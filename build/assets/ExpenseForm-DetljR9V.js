import{aj as be,a6 as fe,r as L,j as e}from"./index-DILgqWJA.js";import{F as je,a as Ne,c as oe,b as m}from"./formik.esm-C25U-yEa.js";import{c as Q,f as de,a as f,e as ve,g as K,h as ke}from"./index.esm-Bxz8Ut03.js";import"./Alert-D3-wLdea.js";import"./index-SDeNNk5o.js";import"./Badge-BEoLkBel.js";import{B as ce}from"./Button-CrFFb1HK.js";import"./Calendar-C5AdBt3B.js";import"./Card-w1_DiXgz.js";import"./Skeleton-ClXa3FSw.js";import{D as Ee}from"./index-zMZy5wTQ.js";import"./Dialog-DcLUleBY.js";import"./Drawer-Fea6rgNO.js";import"./index-BPsTNeyg.js";import{a as c}from"./FormItem-B3r3kvbj.js";import"./useUniqueId-DP_9XaEK.js";import{I as p}from"./Input-Dxk0DyPZ.js";import"./index-DOJf-oVv.js";import"./index-DBmz6eWJ.js";import{t as z,N as B}from"./toast-C21ZMU7w.js";import"./Progress-DE81sLhe.js";import"./index-DeHhTxJu.js";import"./ScrollBar-O1bxnSWz.js";import"./index-C1U_-8ga.js";import"./Select-MW_nRzI-.js";import"./Upload-CcpA6Rzs.js";import"./index-DTKKhEmt.js";import"./Tag-PAsirvtx.js";import"./index-DoIFZwR0.js";import{Y as me,Z as pe}from"./index-CkmhLFFZ.js";import{g as we,f as De,u as qe,c as Se}from"./api-Dku4X4Gi.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-xIXYbZ5s.js";import"./StatusIcon-CveerTQG.js";import"./CloseButton-B_sCjbKz.js";import"./proxy-CGHHffYX.js";import"./floating-ui.react-0XdfaH1n.js";import"./floating-ui.dom-D1IisfOw.js";import"./index-BJIBRJLK.js";import"./useControllableState-BasGrOrn.js";import"./get-B6fDZCrK.js";import"./Views-Bort5Yyy.js";import"./toString-ZniEQAva.js";import"./_getPrototype-CeE0_rZl.js";import"./index-s2HQo4yK.js";import"./index-Chjiymov.js";import"./isNil-Do1TtN__.js";import"./chainedFunction-BxZSneMW.js";import"./index-Cit37NU4.js";const Me=Q().shape({materials:de().of(Q().shape({description:f().required("Description is required"),date:ve().required("Date is required"),invoiceNo:f().required("Invoice number is required"),amount:K().min(0,"Amount must be positive").required("Amount is required"),supplierName:f(),supplierMobile:f(),supplierEmail:f().email("Invalid email format"),file:ke().test("fileSize","File too large (max 5MB)",d=>d?d.size<=5*1024*1024:!0).test("fileType","Unsupported file type",d=>d?["application/pdf","image/jpeg","image/png"].includes(d.type):!0)})),miscellaneous:de().of(Q().shape({description:f().required("Description is required"),quantity:K().min(.01,"Quantity must be at least 0.01").required("Quantity is required"),unitPrice:K().min(.01,"Unit price must be at least 0.01").required("Unit price is required")})),laborDetails:Q().required("Labor details are required")}),wt=()=>{const{projectId:d,expenseId:g}=be(),H=fe(),[l,ue]=L.useState(null),[xe,W]=L.useState({materials:[{description:"",date:new Date,invoiceNo:"",amount:0,supplierName:"",supplierMobile:"",supplierEmail:"",documentUrl:void 0,documentKey:void 0,file:null}],miscellaneous:[{description:"",quantity:1,unitPrice:0,total:0}],laborDetails:{workers:[],driver:null,totalLaborCost:0},totalMaterialCost:0,totalMiscellaneousCost:0}),[ge,Y]=L.useState(!0),[Z,_]=L.useState(!1);L.useEffect(()=>{(async()=>{var o;try{Y(!0);const s=await we(d);if(ue(s.data),g){const r=await De(g),u=r.data.materials.map(a=>({...a,date:new Date(a.date),file:null})),i=((o=r.data.miscellaneous)==null?void 0:o.map(a=>({description:a.description,quantity:a.quantity,unitPrice:a.unitPrice,total:a.total})))||[{description:"",quantity:1,unitPrice:0,total:0}];W({materials:u,miscellaneous:i,laborDetails:r.data.laborDetails,totalMaterialCost:r.data.totalMaterialCost,totalMiscellaneousCost:r.data.totalMiscellaneousCost||0})}else W(r=>({...r,laborDetails:s.data}))}catch(s){z.push(e.jsx(B,{title:"Error",type:"danger",children:"Failed to load required data"})),console.error("Error fetching data:",s)}finally{Y(!1)}})()},[d,g]);const ye=async n=>{var o,s;_(!0);try{const r=new FormData,u=n.materials.map(a=>({description:a.description,date:a.date.toISOString(),invoiceNo:a.invoiceNo,amount:Number(a.amount),supplierName:a.supplierName||void 0,supplierMobile:a.supplierMobile||void 0,supplierEmail:a.supplierEmail||void 0,documentUrl:a.documentUrl,documentKey:a.documentKey})),i=n.miscellaneous.map(a=>({description:a.description,quantity:Number(a.quantity),unitPrice:Number(a.unitPrice),total:Number(a.quantity)*Number(a.unitPrice)}));r.append("materials",JSON.stringify(u)),r.append("miscellaneous",JSON.stringify(i)),r.append("laborDetails",JSON.stringify(n.laborDetails)),n.materials.forEach(a=>{a.file&&r.append("files",a.file)}),g?(await qe(g,r),z.push(e.jsx(B,{title:"Success",type:"success",children:"Expense updated successfully"}))):(await Se(d,r),z.push(e.jsx(B,{title:"Success",type:"success",children:"Expense created successfully"}))),H(`/app/project-view/${d}`)}catch(r){const u=((s=(o=r.response)==null?void 0:o.data)==null?void 0:s.message)||r.message||"Failed to process expense";z.push(e.jsx(B,{title:"Error",type:"danger",children:u}),{placement:"top-center"})}finally{_(!1)}},he=(n,o)=>(n*o).toFixed(2);return ge?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 dark:border-blue-400"})}):e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsx(je,{initialValues:xe,validationSchema:Me,onSubmit:ye,enableReinitialize:!0,children:({values:n,setFieldValue:o,errors:s,touched:r})=>{var u;return e.jsxs(Ne,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Material Expenses"}),e.jsx(oe,{name:"materials",children:({push:i,remove:a})=>e.jsxs("div",{className:"space-y-4",children:[n.materials.map((y,t)=>{var j,N,v,k,E,w,D,q,S,M,P,$,C,F,A,I,U,T,h,x,b,G,V,X,ee,te,ae,re,se,ie,le,ne;return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"Description",invalid:((N=(j=s.materials)==null?void 0:j[t])==null?void 0:N.description)&&((k=(v=r.materials)==null?void 0:v[t])==null?void 0:k.description),errorMessage:(w=(E=s.materials)==null?void 0:E[t])==null?void 0:w.description,children:e.jsx(m,{name:`materials[${t}].description`,as:p,placeholder:"Material description"})}),e.jsx(c,{label:"Date",invalid:((q=(D=s.materials)==null?void 0:D[t])==null?void 0:q.date)&&((M=(S=r.materials)==null?void 0:S[t])==null?void 0:M.date),children:e.jsx(m,{name:`materials[${t}].date`,children:({field:O,form:J})=>e.jsx(Ee,{placeholder:"Select date",value:O.value,onChange:R=>J.setFieldValue(O.name,R)})})}),e.jsx(c,{label:"Invoice Number",invalid:(($=(P=s.materials)==null?void 0:P[t])==null?void 0:$.invoiceNo)&&((F=(C=r.materials)==null?void 0:C[t])==null?void 0:F.invoiceNo),errorMessage:(I=(A=s.materials)==null?void 0:A[t])==null?void 0:I.invoiceNo,children:e.jsx(m,{name:`materials[${t}].invoiceNo`,as:p,placeholder:"Invoice number"})}),e.jsx(c,{label:"Amount (AED)",invalid:((T=(U=s.materials)==null?void 0:U[t])==null?void 0:T.amount)&&((x=(h=r.materials)==null?void 0:h[t])==null?void 0:x.amount),errorMessage:(G=(b=s.materials)==null?void 0:b[t])==null?void 0:G.amount,children:e.jsx(m,{name:`materials[${t}].amount`,type:"number",as:p,placeholder:"Amount",min:"0",step:"0.01"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsx(c,{label:"Supplier Name",children:e.jsx(m,{name:`materials[${t}].supplierName`,as:p,placeholder:"Supplier name"})}),e.jsx(c,{label:"Supplier Mobile",children:e.jsx(m,{name:`materials[${t}].supplierMobile`,as:p,placeholder:"Supplier mobile"})}),e.jsx(c,{label:"Supplier Email",invalid:((X=(V=s.materials)==null?void 0:V[t])==null?void 0:X.supplierEmail)&&((te=(ee=r.materials)==null?void 0:ee[t])==null?void 0:te.supplierEmail),errorMessage:(re=(ae=s.materials)==null?void 0:ae[t])==null?void 0:re.supplierEmail,children:e.jsx(m,{name:`materials[${t}].supplierEmail`,as:p,placeholder:"Supplier email",type:"email"})})]}),e.jsx("div",{className:"mt-4",children:e.jsxs(c,{label:"Document Attachment",invalid:(ie=(se=s.materials)==null?void 0:se[t])==null?void 0:ie.file,errorMessage:(ne=(le=s.materials)==null?void 0:le[t])==null?void 0:ne.file,children:[e.jsx("input",{type:"file",onChange:O=>{var R;const J=((R=O.target.files)==null?void 0:R[0])||null;o(`materials[${t}].file`,J)},className:`block w-full text-sm text-gray-500\r
                                file:mr-4 file:py-2 file:px-4\r
                                file:rounded-md file:border-0\r
                                file:text-sm file:font-semibold\r
                                file:bg-blue-50 file:text-blue-700\r
                                hover:file:bg-blue-100\r
                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png"}),y.documentUrl&&!y.file&&e.jsx("div",{className:"mt-2",children:e.jsx("a",{href:y.documentUrl,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300",children:"View Current Document"})}),y.file&&e.jsxs("div",{className:"mt-2 text-sm text-green-600 dark:text-green-400",children:["New file selected: ",y.file.name]})]})}),n.materials.length>1&&e.jsx("div",{className:"flex justify-end mt-4",children:e.jsxs("button",{type:"button",onClick:()=>a(t),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 flex items-center",children:[e.jsx(me,{className:"mr-1"}),"Remove Item"]})})]},t)}),e.jsxs("button",{type:"button",onClick:()=>i({description:"",date:new Date,invoiceNo:"",amount:0,supplierName:"",supplierMobile:"",supplierEmail:"",file:null}),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none dark:bg-blue-500 dark:hover:bg-blue-600",children:[e.jsx(pe,{className:"mr-1"}),"Add Material"]})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Miscellaneous Expenses"}),e.jsx(oe,{name:"miscellaneous",children:({push:i,remove:a})=>e.jsxs("div",{className:"space-y-4",children:[n.miscellaneous.map((y,t)=>{var j,N,v,k,E,w,D,q,S,M,P,$,C,F,A,I,U,T;return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(c,{label:"Description",invalid:((N=(j=s.miscellaneous)==null?void 0:j[t])==null?void 0:N.description)&&((k=(v=r.miscellaneous)==null?void 0:v[t])==null?void 0:k.description),errorMessage:(w=(E=s.miscellaneous)==null?void 0:E[t])==null?void 0:w.description,children:e.jsx(m,{name:`miscellaneous[${t}].description`,as:p,placeholder:"Expense description"})}),e.jsx(c,{label:"Quantity",invalid:((q=(D=s.miscellaneous)==null?void 0:D[t])==null?void 0:q.quantity)&&((M=(S=r.miscellaneous)==null?void 0:S[t])==null?void 0:M.quantity),errorMessage:($=(P=s.miscellaneous)==null?void 0:P[t])==null?void 0:$.quantity,children:e.jsx(m,{name:`miscellaneous[${t}].quantity`,type:"number",as:p,placeholder:"Quantity",min:"0.01",step:"0.01",onChange:h=>{const x=parseFloat(h.target.value)||0,b=parseFloat(n.miscellaneous[t].unitPrice.toString())||0;o(`miscellaneous[${t}].quantity`,x),o(`miscellaneous[${t}].total`,x*b)}})}),e.jsx(c,{label:"Unit Price (AED)",invalid:((F=(C=s.miscellaneous)==null?void 0:C[t])==null?void 0:F.unitPrice)&&((I=(A=r.miscellaneous)==null?void 0:A[t])==null?void 0:I.unitPrice),errorMessage:(T=(U=s.miscellaneous)==null?void 0:U[t])==null?void 0:T.unitPrice,children:e.jsx(m,{name:`miscellaneous[${t}].unitPrice`,type:"number",as:p,placeholder:"Unit price",min:"0.01",step:"0.01",onChange:h=>{const x=parseFloat(h.target.value)||0,b=parseFloat(n.miscellaneous[t].quantity.toString())||0;o(`miscellaneous[${t}].unitPrice`,x),o(`miscellaneous[${t}].total`,b*x)}})})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-3 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1",children:"Total"}),e.jsxs("div",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:["AED ",he(parseFloat(n.miscellaneous[t].quantity.toString())||0,parseFloat(n.miscellaneous[t].unitPrice.toString())||0)]})]})}),n.miscellaneous.length>1&&e.jsx("div",{className:"flex justify-end mt-4",children:e.jsxs("button",{type:"button",onClick:()=>a(t),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 flex items-center",children:[e.jsx(me,{className:"mr-1"}),"Remove Item"]})})]},t)}),e.jsxs("button",{type:"button",onClick:()=>i({description:"",quantity:1,unitPrice:0,total:0}),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none dark:bg-blue-500 dark:hover:bg-blue-600",children:[e.jsx(pe,{className:"mr-1"}),"Add Miscellaneous Expense"]})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Labor Details"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium mb-3 text-gray-900 dark:text-gray-100",children:"Workers"}),(u=l==null?void 0:l.workers)!=null&&u.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Days Present"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Daily Salary"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Total"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:l.workers.map((i,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[i.profileImage&&e.jsx("img",{className:"h-10 w-10 rounded-full mr-3",src:i.profileImage,alt:`${i.firstName} ${i.lastName}`}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:[i.firstName," ",i.lastName]})]})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:i.daysPresent}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:["AED ",i.dailySalary.toFixed(2)]}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:["AED ",i.totalSalary.toFixed(2)]})]},a))})]})}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No workers assigned to this project"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-3 text-gray-900 dark:text-gray-100",children:"Driver"}),l!=null&&l.driver?e.jsxs("div",{className:"flex items-center space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[l.driver.profileImage&&e.jsx("img",{className:"h-12 w-12 rounded-full",src:l.driver.profileImage,alt:`${l.driver.firstName} ${l.driver.lastName}`}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:[l.driver.firstName," ",l.driver.lastName]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Days Present"}),e.jsx("div",{className:"text-gray-900 dark:text-gray-100",children:l.driver.daysPresent})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Daily Salary"}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:["AED ",l.driver.dailySalary.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Total"}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:["AED ",l.driver.totalSalary.toFixed(2)]})]})]})]})]}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No driver assigned to this project"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Expense Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Material Cost"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100",children:["AED ",n.materials.reduce((i,a)=>i+Number(a.amount),0).toFixed(2)]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Misc Cost"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100",children:["AED ",n.miscellaneous.reduce((i,a)=>i+Number(a.quantity)*Number(a.unitPrice),0).toFixed(2)]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Labor Cost"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100",children:["AED ",(l==null?void 0:l.totalLaborCost.toFixed(2))||"0.00"]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Expense"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-green-600 dark:text-green-400",children:["AED ",(n.materials.reduce((i,a)=>i+Number(a.amount),0)+n.miscellaneous.reduce((i,a)=>i+Number(a.quantity)*Number(a.unitPrice),0)+((l==null?void 0:l.totalLaborCost)||0)).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-3 flex justify-between shadow-lg",children:[e.jsx(ce,{type:"button",onClick:()=>H(`/projects/${d}/expenses`),variant:"plain",children:"Cancel"}),e.jsx(ce,{type:"submit",variant:"solid",color:"blue-600",loading:Z,disabled:Z,children:g?"Update Expense":"Create Expense"})]})]})}})})};export{wt as default};
