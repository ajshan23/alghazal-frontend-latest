import{an as T,j as e,r as m,u as G,ak as F,a3 as M,b as k}from"./index-3DLZI4eB.js";import{C as L}from"./Views-CKmk2VLX.js";import{C as B}from"./Card-CF9KcGlH.js";import{B as D}from"./Button-C9ww9UOL.js";import{L as V}from"./Logo-DKzeQGWm.js";import"./Alert-BJMUWgWX.js";import"./index-DPb5rspz.js";import"./Badge-B2aEm3Jr.js";import"./Calendar-D9WkR1Rr.js";import"./Skeleton-DYaberbX.js";import"./index-ao32mJN_.js";import{D as U}from"./Dialog-Crbi-7-g.js";import"./Drawer-CRdlTkRI.js";import"./index-ZVEP2S7b.js";import"./FormItem-BL-V7KWu.js";import"./useUniqueId-DI0oL57o.js";import{I as O}from"./Input-BCKKbbYo.js";import"./index-D7-L48mv.js";import"./index-CeldJ5wE.js";import{t as f,N}from"./toast-BKi6XR_M.js";import"./Progress-C0wqBKPQ.js";import"./index-BvIUGnE1.js";import"./ScrollBar-CvhjHryd.js";import"./index-FxzcmWEN.js";import"./Select-DbBYdRQK.js";import"./Upload-BGoPt-4d.js";import{T as S}from"./index-B2vv1dQX.js";import"./Tag-BEvWyzit.js";import"./index-wZuuJ2Y4.js";import{u as q}from"./useThemeClass-B_GK6Zwz.js";import{c as H,u as Y,g as $,f as A}from"./index-CgdDCE4T.js";import{N as W}from"./react-number-format.es--3o-nK0W.js";import"./context-DV85rUc2.js";import"./StatusIcon-B68Axw2m.js";import"./index-CwjAikcA.js";import"./CloseButton-wNJpnAMz.js";import"./proxy-h8u1Q_39.js";import"./floating-ui.react-BR9Qsiv-.js";import"./floating-ui.dom-D1IisfOw.js";import"./index-ejasuVWi.js";import"./useControllableState-P_D4vZ7w.js";import"./_getPrototype-BB9zh0H4.js";import"./index-DpelZirJ.js";import"./index-Chjiymov.js";import"./toString-Cp3uycBW.js";import"./chainedFunction-BxZSneMW.js";import"./index-lyoTauZ5.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./hoist-non-react-statics.cjs-DT5H6Lbl.js";import"./index-VcVS_xjk.js";const z=async s=>{var t,a;try{const r=await T.get(`/project/${s}/invoice`);if(!r.data)throw new Error("No data received from server");return r.data.data}catch(r){throw console.error("API Error:",r),new Error(((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to fetch invoice data")}},Q=async s=>{try{return console.log("Downloading invoice PDF for project:",s),(await T.get(`/project/${s}/invoice/pdf`,{responseType:"blob"})).data}catch(t){throw console.error("Error downloading invoice PDF:",t),t}},X=async(s,t)=>{try{return(await T.put(`/project/${s}/grn-number`,{grnNumber:t})).data}catch(a){throw console.error("Error adding GRN number:",a),a}},{Tr:E,Th:_,Td:x,THead:J,TBody:K,TFoot:Z}=S,I=({label:s,value:t})=>e.jsxs(E,{children:[e.jsx(x,{className:"!border-t-0",colSpan:3}),e.jsx(x,{className:"font-semibold !border-t-0 text-right",children:s}),e.jsx(x,{className:"!py-3 !border-t-0",children:e.jsx(P,{amount:t})})]}),P=({amount:s=0})=>e.jsx(W,{displayType:"text",value:(Math.round(s*100)/100).toFixed(2),suffix:" AED",thousandSeparator:!0}),w=H(),ee=[w.accessor("sno",{header:"Item",cell:s=>s.getValue()}),w.accessor("description",{header:"Description"}),w.accessor("qty",{header:"Qty"}),w.accessor("unitPrice",{header:"Unit Price (AED)",cell:s=>e.jsx(P,{amount:s.getValue()})}),w.accessor("total",{header:"Total (AED)",cell:s=>e.jsx(P,{amount:s.getValue()})})],re=({products:s=[],summary:t={}})=>{const a=Y({data:s,columns:ee,getCoreRowModel:$()});return e.jsxs(S,{children:[e.jsx(J,{children:a.getHeaderGroups().map(r=>e.jsx(E,{children:r.headers.map(n=>e.jsx(_,{colSpan:n.colSpan,children:A(n.column.columnDef.header,n.getContext())},n.id))},r.id))}),e.jsx(K,{children:a.getRowModel().rows.map(r=>e.jsx(E,{children:r.getVisibleCells().map(n=>e.jsx(x,{children:A(n.column.columnDef.cell,n.getContext())},n.id))},r.id))}),e.jsxs(Z,{children:[e.jsx(I,{label:"Amount (AED)",value:t.amount}),e.jsx(I,{label:"VAT 5% (AED)",value:t.vat}),e.jsxs(E,{children:[e.jsx(x,{className:"!border-t-0",colSpan:3}),e.jsx(x,{className:"font-semibold text-base text-right",children:"Total Receivable (AED)"}),e.jsx(x,{className:"font-semibold text-base !py-3",children:e.jsx(P,{amount:t.totalReceivable})})]})]})]})},se=({isOpen:s,onClose:t,onSave:a,projectId:r,refetch:n,number:i})=>{const[c,v]=m.useState(i||""),[j,u]=m.useState(""),[h,l]=m.useState(!1);m.useEffect(()=>{v(i||""),u("")},[s,i]);const g=y=>{v(y.target.value),j&&u("")},C=async y=>{var R,o,b;if(y.preventDefault(),!c.trim()){u("GRN number is required");return}if(i&&c===i){f.push(e.jsx(N,{title:"Info",type:"info",duration:2500,children:"GRN number hasn't changed"}),{placement:"top-center"}),t();return}try{l(!0),u(""),await X(r,c),n(),a==null||a(c),f.push(e.jsxs(N,{title:"Success",type:"success",duration:2500,children:[i?"GRN number updated":"GRN number saved"," successfully"]}),{placement:"top-center"}),t()}catch(d){const p=((o=(R=d==null?void 0:d.response)==null?void 0:R.data)==null?void 0:o.message)||((b=d==null?void 0:d.data)==null?void 0:b.message)||d.message||"Failed to save GRN number";u(p),f.push(e.jsx(N,{title:"Error",type:"danger",duration:2500,children:p}),{placement:"top-center"})}finally{l(!1)}};return e.jsxs(U,{isOpen:s,onClose:t,onRequestClose:t,width:500,children:[e.jsx("h5",{className:"mb-4",children:i?"Update GRN Number":"Add GRN Number"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{htmlFor:"grnNumber",className:"block mb-2",children:["GRN Number ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(O,{id:"grnNumber",placeholder:"Enter GRN number",value:c,onChange:g,disabled:h}),j&&e.jsx("p",{className:"mt-1 text-red-500",children:j})]}),e.jsxs("div",{className:"text-right mt-6",children:[e.jsx(D,{className:"ltr:mr-2 rtl:ml-2",variant:"plain",onClick:t,disabled:h,children:"Cancel"}),e.jsx(D,{variant:"solid",onClick:C,loading:h,children:h?"Processing...":i?"Update":"Save"})]})]})},te=()=>{q();const s=G(o=>o.theme.mode),[t,a]=m.useState(!0),[r,n]=m.useState(null),[i,c]=m.useState(null),[v,j]=m.useState(!1),[u,h]=m.useState(!1),{projectId:l}=F(),g=async()=>{try{if(a(!0),c(null),!l)throw new Error("Project ID is required");const o=await z(l);if(!o||!o.invoiceNumber||!o.vendor||!o.vendee||!Array.isArray(o.products))throw new Error("Invalid invoice data received from server");n(o)}catch(o){console.error("Error fetching invoice data:",o),c(o instanceof Error?o.message:"Failed to load invoice data")}finally{a(!1)}};m.useEffect(()=>{g()},[l]);const C=async()=>{var o;if(!l){f.push(e.jsx(N,{title:"Error",type:"danger",children:"Project ID is required"}));return}j(!0),c(null);try{const b=await Q(l),d=window.URL.createObjectURL(new Blob([b])),p=document.createElement("a");p.href=d,p.setAttribute("download",`invoice_${(r==null?void 0:r.invoiceNumber)||l}.pdf`),document.body.appendChild(p),p.click(),(o=p.parentNode)==null||o.removeChild(p),window.URL.revokeObjectURL(d),f.push(e.jsx(N,{title:"Success",type:"success",children:"PDF downloaded successfully"}))}catch(b){console.error("PDF download error:",b),c("Failed to download PDF"),f.push(e.jsx(N,{title:"Error",type:"danger",children:"Failed to download PDF"}))}finally{j(!1)}},y=()=>{h(!0)},R=()=>{h(!1)};return i?e.jsxs("div",{className:"p-4 text-center text-red-500",children:[i,e.jsx(D,{className:"mt-4",onClick:g,children:"Retry"})]}):t||!r?e.jsx(M,{loading:!0}):e.jsxs("div",{className:"print:p-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx(V,{className:"mb-3",mode:s}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"TAX INVOICE"})]}),e.jsx("div",{className:"my-4",children:e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["PO Box No: ",r.vendor.poBox]}),e.jsxs("span",{children:["Date: ",k(r.date).format("DD/MM/YYYY")]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Dubai, UAE"}),e.jsxs("span",{children:["INV #: ",r.invoiceNumber]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Website: www.alghazalgroup.com"}),e.jsxs("span",{children:["Order No: ",r.orderNumber]})]})]})})]}),e.jsx("div",{className:"border-t border-b border-gray-200 dark:border-gray-600 py-4 my-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold mb-2",children:"Vendee"}),e.jsxs("p",{className:"whitespace-pre-line",children:[r.vendee.name,e.jsx("br",{}),r.vendee.contactPerson,e.jsx("br",{}),r.vendee.address,e.jsx("br",{}),"Phone: ",r.vendee.phone,e.jsx("br",{}),"TRN#: ",r.vendee.trn]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold mb-2",children:"Vendor"}),e.jsxs("p",{className:"whitespace-pre-line",children:[r.vendor.name,e.jsx("br",{}),"PB: ",r.vendor.poBox," ",r.vendor.address,e.jsx("br",{}),"Phone: ",r.vendor.phone,e.jsx("br",{}),"TRN#: ",r.vendor.trn,e.jsx("br",{}),"GRN Number: ",r.vendee.grnNumber,e.jsx("br",{}),"LPO No.: ",r.vendee.supplierNumber,e.jsx("br",{}),"Service Period: ",r.vendee.servicePeriod]})]})]})}),e.jsxs("div",{className:"my-6",children:[e.jsx("h4",{className:"font-bold",children:"Subject:"}),e.jsx("p",{children:r.subject})]}),e.jsx("div",{className:"my-6",children:e.jsx(re,{products:r.products,summary:r.summary})}),e.jsxs("div",{className:"my-6",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Comments or special instructions"}),e.jsxs("p",{children:["Payment: ",r.paymentTerms]}),e.jsxs("p",{children:["Amt in Words: ",r.amountInWords]})]}),e.jsx("div",{className:"mt-8"}),e.jsxs("div",{className:"print:hidden mt-6 flex items-center justify-end gap-2",children:[e.jsx(D,{variant:"solid",onClick:y,className:"mr-2",children:"Add GRN number"}),e.jsx(D,{variant:"solid",loading:v,onClick:C,children:v?"Generating PDF...":"Download Invoice"})]}),e.jsx(se,{isOpen:u,onClose:R,projectId:l,number:r.vendee.grnNumber,refetch:g})]})},rr=()=>e.jsx(L,{className:"h-full",children:e.jsx(B,{className:"h-full",bodyClass:"h-full",children:e.jsx(te,{})})});export{rr as default};
