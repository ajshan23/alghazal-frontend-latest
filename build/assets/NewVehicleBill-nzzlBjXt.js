import{r as u,j as e,v as J,ak as U}from"./index-3DLZI4eB.js";import{N as T,t as q}from"./toast-BKi6XR_M.js";import{c as Q,f as Y,h as G,i as K,j as W}from"./api-DhT08BlI.js";import{F as X,a as b}from"./FormItem-BL-V7KWu.js";import{B as O}from"./Button-C9ww9UOL.js";import{S as Z}from"./StickyFooter-BOIaEWjh.js";import{F as ee,a as te,b as y}from"./formik.esm-Cif10a7Y.js";import{A as ae}from"./index-DrvqYkYN.js";import{a5 as _}from"./index-CwjAikcA.js";import{c as ie,a as S,e as le,f as se,g as re,h as oe}from"./index.esm-DW5bWfqO.js";import"./Alert-BJMUWgWX.js";import"./index-DPb5rspz.js";import"./Badge-B2aEm3Jr.js";import"./Calendar-D9WkR1Rr.js";import"./Card-CF9KcGlH.js";import"./Skeleton-DYaberbX.js";import{D as ne}from"./index-ao32mJN_.js";import"./Dialog-Crbi-7-g.js";import"./Drawer-CRdlTkRI.js";import"./index-ZVEP2S7b.js";import"./useUniqueId-DI0oL57o.js";import{I as V}from"./Input-BCKKbbYo.js";import"./index-D7-L48mv.js";import"./index-CeldJ5wE.js";import"./Progress-C0wqBKPQ.js";import"./index-BvIUGnE1.js";import"./ScrollBar-CvhjHryd.js";import"./index-FxzcmWEN.js";import{S as E}from"./Select-DbBYdRQK.js";import"./Upload-BGoPt-4d.js";import"./index-B2vv1dQX.js";import"./Tag-BEvWyzit.js";import"./index-wZuuJ2Y4.js";import{A as P}from"./AdaptableCard-DUhwjOtA.js";import"./Views-CKmk2VLX.js";import"./chart.config-BThG8UO4.js";import"./DataTable-CU1UK92B.js";import"./SvgIcon-7l9PnEWY.js";import"./SegmentItemOption-D9nyfC21.js";import{f as ce}from"./format-BzRktsyD.js";import"./StatusIcon-B68Axw2m.js";import"./CloseButton-wNJpnAMz.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-h8u1Q_39.js";import"./context-DV85rUc2.js";import"./index-ejasuVWi.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-DT5H6Lbl.js";import"./floating-ui.react-BR9Qsiv-.js";import"./floating-ui.dom-D1IisfOw.js";import"./useControllableState-P_D4vZ7w.js";import"./_getPrototype-BB9zh0H4.js";import"./index-DpelZirJ.js";import"./index-Chjiymov.js";import"./toString-Cp3uycBW.js";import"./index-lyoTauZ5.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./index-VcVS_xjk.js";import"./index-CgdDCE4T.js";import"./useThemeClass-B_GK6Zwz.js";const me=new Date,$=[{label:"ADCB",value:"adcb"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"masherq_card"},{label:"ATHEER PLUS",value:"atheer_plus"}],L=u.forwardRef((g,p)=>{const{type:w,initialData:n={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},onFormSubmit:I,onDiscard:j,onDelete:k}=g,[N,F]=u.useState([]),[A,M]=u.useState([]),[m,c]=u.useState([]),[D,B]=u.useState(!0);u.useEffect(()=>{n.attachments&&F(n.attachments)},[n]),u.useEffect(()=>{(async()=>{var s,i,f;try{const v=await Q(),r=(s=v==null?void 0:v.data)==null?void 0:s.vehicles.map(a=>({label:a.vehicleNumber,value:a._id}));M(r||[]);const o=((f=(i=(await Y()).data)==null?void 0:i.shops)==null?void 0:f.map(a=>({label:a.shopName,value:a._id})))||[];c(o)}catch(v){console.error("Failed to load data:",v)}finally{B(!1)}})()},[]);const C=ie().shape({billType:S().required("Bill type is required"),billDate:le().required("Bill date is required").typeError("Please select a valid date"),purpose:S().required("Purpose is required"),vehicles:se().of(S()).min(1,"At least one vehicle must be selected").required("Vehicle selection is required"),paymentMethod:S().required("Payment method is required"),amount:re().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),shop:S().required("Shop is required"),remarks:S().max(500,"Remarks must be at most 500 characters"),attachments:oe()}),d=l=>{if(l.target.files&&l.target.files.length>0){const s=Array.from(l.target.files);F(i=>[...i,...s])}},z=l=>{F(s=>s.filter((i,f)=>f!==l))},H=()=>({billType:n.billType,billDate:n.billDate,purpose:n.purpose,vehicles:n.vehicles.map(l=>l._id),invoiceNo:n.invoiceNo,paymentMethod:n.paymentMethod,amount:n.amount,shop:n.shop._id,remarks:n.remarks,attachments:n.attachments});return e.jsx(ee,{innerRef:p,initialValues:H(),validationSchema:C,onSubmit:async(l,{setSubmitting:s,setErrors:i})=>{var f,v;try{const r=new FormData;r.append("billType",l.billType),r.append("billDate",l.billDate),r.append("purpose",l.purpose),l.vehicles.forEach(t=>{r.append("vehicles[]",t)}),r.append("invoiceNo",l.invoiceNo),r.append("paymentMethod",l.paymentMethod),r.append("amount",l.amount.toString()),r.append("shop",l.shop),r.append("remarks",l.remarks||""),N.forEach((t,o)=>{t instanceof File?r.append("attachments",t):typeof t=="string"&&w==="edit"&&r.append(`existingAttachments[${o}]`,t)}),await I(r,s)}catch(r){s(!1),(v=(f=r.response)==null?void 0:f.data)!=null&&v.errors&&i(r.response.data.errors),console.error("Form submission error:",r)}},enableReinitialize:!0,children:({values:l,touched:s,errors:i,isSubmitting:f,setFieldValue:v,handleBlur:r})=>e.jsx(te,{children:e.jsxs(X,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Vehicle Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(b,{label:"Bill Type",invalid:!!i.billType&&s.billType,errorMessage:i.billType,children:e.jsx(y,{name:"billType",children:({field:t,form:o})=>{const a=[{label:"Vehicle",value:"vehicle",disabled:!0}],h=a.find(x=>x.value===t.value)||a[0];return e.jsx(E,{options:a,value:h,isOptionDisabled:x=>x.disabled,onChange:x=>{o.setFieldValue(t.name,x==null?void 0:x.value)},onBlur:t.onBlur,name:t.name})}})}),e.jsx(b,{label:"Bill Date",invalid:!!i.billDate&&s.billDate,children:e.jsx(y,{name:"billDate",children:({field:t,form:o})=>e.jsx(ne,{placeholder:"Select billDate Date",value:t.value?new Date(t.value):null,maxDate:me,onChange:a=>o.setFieldValue(t.name,a?ce(new Date(a.getFullYear(),a.getMonth(),a.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(b,{label:"Purpose",invalid:!!i.purpose&&s.purpose,errorMessage:i.purpose,children:e.jsx(y,{name:"purpose",children:({field:t})=>e.jsx(V,{type:"text",autoComplete:"off",placeholder:"Purpose",...t})})}),e.jsx(b,{label:"Vehicle",invalid:!!i.vehicles&&s.vehicles,errorMessage:i.vehicles,children:e.jsx(y,{name:"vehicles",children:({field:t,form:o})=>e.jsx(E,{placeholder:"Select Vehicle(s)",options:A,isMulti:!0,value:A.filter(a=>l.vehicles.includes(a.value)),onChange:a=>{const h=a?a.map(x=>x.value):[];o.setFieldValue(t.name,h)},onBlur:t.onBlur,loading:D})})}),e.jsx(b,{label:"Invoice No",invalid:!!i.invoiceNo&&s.invoiceNo,errorMessage:i.invoiceNo,children:e.jsx(y,{name:"invoiceNo",children:({field:t})=>e.jsx(V,{type:"text",autoComplete:"off",placeholder:"Invoice number",...t})})}),e.jsx(b,{label:"Payment Method",invalid:!!i.paymentMethod&&s.paymentMethod,errorMessage:i.paymentMethod,children:e.jsx(y,{name:"paymentMethod",children:({field:t,form:o})=>e.jsx(E,{placeholder:"Select Payment Method",options:$,value:$.find(a=>a.value===l.paymentMethod),onChange:a=>{o.setFieldValue(t.name,(a==null?void 0:a.value)||"")},onBlur:t.onBlur})})}),e.jsx(b,{label:"Amount",invalid:!!i.amount&&s.amount,errorMessage:i.amount,children:e.jsx(y,{name:"amount",children:({field:t,form:o})=>e.jsx(V,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:a=>{o.setFieldValue(t.name,a.target.value)}})})}),e.jsx(b,{label:"Shop",invalid:!!i.shop&&s.shop,errorMessage:i.shop,children:e.jsx(y,{name:"shop",children:({field:t,form:o})=>{const a=m.find(h=>h.value===t.value)||null;return e.jsx(E,{placeholder:D?"Loading shops...":"Select Shop",options:m,value:a,onChange:h=>o.setFieldValue(t.name,(h==null?void 0:h.value)||""),loading:D})}})})]})]}),e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(b,{label:"Attachments",invalid:!!i.attachments&&s.attachments,errorMessage:i.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:d,onBlur:()=>r({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500\r
                                                file:mr-4 file:py-2 file:px-4\r
                                                file:rounded-md file:border-0\r
                                                file:text-sm file:font-semibold\r
                                                file:bg-blue-50 file:text-blue-700\r
                                                hover:file:bg-blue-100\r
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),N.length>0&&e.jsx("div",{className:"space-y-2",children:N.map((t,o)=>{let a,h;return t instanceof File?a=t.name:typeof t=="object"&&t!==null?(a=t.fileName||t.filePath||"Attachment",h=t._id):typeof t=="string"?a=t:a="Attachment",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:a}),e.jsx("button",{type:"button",onClick:()=>z(o),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(_,{})})]},h||o)})})]})]}),e.jsxs(P,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(b,{label:"Remarks",invalid:!!i.remarks&&s.remarks,errorMessage:i.remarks,children:e.jsx(y,{name:"remarks",children:({field:t})=>e.jsx(V,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...t})})})]})]})}),e.jsxs(Z,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:w==="edit"&&k&&e.jsx(O,{size:"sm",variant:"plain",color:"red",icon:e.jsx(_,{}),type:"button",onClick:()=>k(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(O,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(O,{size:"sm",variant:"solid",loading:f,icon:e.jsx(ae,{}),type:"submit",children:"Save"})]})]})]})})})});L.displayName="VehicleBillForm";const R={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},xt=()=>{const g=J(),{id:p}=U(),[w,n]=u.useState(R),[I,j]=u.useState(!!p),[k,N]=u.useState(null);u.useEffect(()=>{if(!p){n(R),j(!1);return}(async()=>{try{j(!0);const m=await G(p);if(!(m!=null&&m.data))throw new Error("Invalid bill data received");const{data:c}=m;n({billType:c.billType||"vehicle",billDate:c.billDate?c.billDate.split("T")[0]:new Date().toISOString().split("T")[0],purpose:c.purpose||"",vehicles:c.vehicles||[],invoiceNo:c.invoiceNo||"",paymentMethod:c.paymentMethod||"",amount:c.amount||0,shop:c.shop||{_id:"",shopName:"",shopNo:""},remarks:c.remarks||"",attachments:c.attachments||[]}),N(null)}catch(m){console.error("Error fetching bill:",m),N(m.message||"Failed to load bill data"),q.push(e.jsx(T,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:m.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>g("/app/vehicle-bill-view"),2500)}finally{j(!1)}})()},[p,g]);const F=async(M,m)=>{var c,D,B,C;try{m(!0);const d=p?await K(p,M):await W(M);if([200,201].includes(d.status))q.push(e.jsxs(T,{title:`Successfully ${p?"updated":"added"} vehicle bill`,type:"success",duration:2500,children:["Vehicle bill ",p?"updated":"added"," successfully"]}),{placement:"top-center"}),g("/app/vehicle-bill-view");else throw new Error(((D=(c=d==null?void 0:d.response)==null?void 0:c.data)==null?void 0:D.message)||"Unexpected status code")}catch(d){console.error("Error during form submission:",d),q.push(e.jsx(T,{title:`Error ${p?"updating":"adding"} vehicle bill`,type:"danger",duration:2500,children:((C=(B=d==null?void 0:d.response)==null?void 0:B.data)==null?void 0:C.message)||d.message}),{placement:"top-center"})}finally{m(!1)}},A=()=>{JSON.stringify(w)!==JSON.stringify(R)?window.confirm("Are you sure you want to discard changes?")&&g("/app/vehicle-bill-view"):g("/app/vehicle-bill-view")};return I?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(T,{title:"Error loading vehicle bill",type:"danger",children:k})}):e.jsx(L,{type:p?"edit":"new",initialData:w,onFormSubmit:F,onDiscard:A})};export{xt as default};
