import{r as m,j as e,an as E,u as B,aj as A,a6 as H,a1 as L,b as D}from"./index-DILgqWJA.js";import{C as G}from"./Views-Bort5Yyy.js";import{C as W}from"./Card-w1_DiXgz.js";import{B as x}from"./Button-CrFFb1HK.js";import{L as _}from"./Logo-CQcQH0Fo.js";import{aF as q,Y as z,aw as J,a4 as V,aG as O}from"./index-CkmhLFFZ.js";import{u as K}from"./useThemeClass-COrJaNxG.js";import"./Alert-D3-wLdea.js";import"./index-SDeNNk5o.js";import"./Badge-BEoLkBel.js";import"./Calendar-C5AdBt3B.js";import"./Skeleton-ClXa3FSw.js";import"./index-zMZy5wTQ.js";import{D as Q}from"./Dialog-DcLUleBY.js";import"./Drawer-Fea6rgNO.js";import"./index-BPsTNeyg.js";import{F as X,a as R}from"./FormItem-B3r3kvbj.js";import"./useUniqueId-DP_9XaEK.js";import{I as T}from"./Input-Dxk0DyPZ.js";import"./index-DOJf-oVv.js";import"./index-DBmz6eWJ.js";import{t as b,N as v}from"./toast-C21ZMU7w.js";import"./Progress-DE81sLhe.js";import"./index-DeHhTxJu.js";import"./ScrollBar-O1bxnSWz.js";import"./index-C1U_-8ga.js";import"./Select-MW_nRzI-.js";import{U as Z}from"./Upload-CcpA6Rzs.js";import"./index-DTKKhEmt.js";import"./Tag-PAsirvtx.js";import"./index-DoIFZwR0.js";import"./StatusIcon-CveerTQG.js";import"./CloseButton-B_sCjbKz.js";import"./proxy-CGHHffYX.js";import"./floating-ui.react-0XdfaH1n.js";import"./floating-ui.dom-D1IisfOw.js";import"./index-BJIBRJLK.js";import"./useControllableState-BasGrOrn.js";import"./get-B6fDZCrK.js";import"./toString-ZniEQAva.js";import"./_getPrototype-CeE0_rZl.js";import"./index-s2HQo4yK.js";import"./index-Chjiymov.js";import"./isNil-Do1TtN__.js";import"./chainedFunction-BxZSneMW.js";import"./hoist-non-react-statics.cjs-xIXYbZ5s.js";import"./index-Cit37NU4.js";const ee=({isOpen:l,onClose:r,onUpload:p,projectId:n})=>{const[s,u]=m.useState([]),[g,j]=m.useState([]),[w,f]=m.useState([]),P=m.useRef(null),y=t=>{if(t&&t.length>0){const o=Array.from(t).map(a=>({id:`${a.name}-${Date.now()}`,name:a.name,type:a.type,size:a.size,file:a}));u(a=>[...a,...o]),j(a=>[...a,...o.map(()=>"")]),f(a=>[...a,...o.map(()=>"")])}return!1},k=(t,o)=>{j(a=>{const c=[...a];return c[t]=o,c})},M=(t,o)=>{f(a=>{const c=[...a];return c[t]=o,c})},h=t=>{u(o=>o.filter((a,c)=>c!==t)),j(o=>o.filter((a,c)=>c!==t)),f(o=>o.filter((a,c)=>c!==t))},F=()=>{const t=s.map(o=>o.file);p(t,g,w),u([]),j([]),f([]),r()};return e.jsxs(Q,{isOpen:l,onClose:r,onRequestClose:r,width:800,children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("h4",{children:"Upload Work Completion Images"})}),e.jsxs("div",{className:"mb-6",children:[e.jsx(Z,{ref:P,beforeUpload:y,showList:!1,multiple:!0,accept:"image/*",children:e.jsx(x,{variant:"solid",icon:e.jsx(q,{}),type:"button",children:"Select Images"})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Upload images of completed work (JPEG, PNG)"})]}),s.length>0&&e.jsx("div",{className:"max-h-96 overflow-y-auto",children:s.map((t,o)=>e.jsx("div",{className:"mb-4 p-4 border rounded",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-24 h-24 bg-gray-100 rounded overflow-hidden",children:t.type.startsWith("image/")&&e.jsx("img",{src:URL.createObjectURL(t.file),alt:t.name,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"flex-1",children:e.jsxs(X,{children:[e.jsx(R,{label:"Title",className:"mb-3",children:e.jsx(T,{value:g[o]||"",onChange:a=>k(o,a.target.value),placeholder:"Enter image title",required:!0})}),e.jsx(R,{label:"Description (Optional)",children:e.jsx(T,{value:w[o]||"",onChange:a=>M(o,a.target.value),placeholder:"Enter description"})})]})}),e.jsx(x,{shape:"circle",variant:"plain",icon:e.jsx(z,{}),onClick:()=>h(o),className:"text-red-500 hover:text-red-600"})]})},t.id))}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(x,{variant:"plain",onClick:r,children:"Cancel"}),e.jsx(x,{variant:"solid",onClick:F,disabled:s.length===0||g.some(t=>!(t!=null&&t.trim())),children:"Upload Images"})]})]})},$=async l=>{try{const r=await E.get(`/work-completion/project/${l}/work-comp`);return console.log(r.data),r.data}catch(r){throw console.error("Error fetching completion data:",r),r}},se=async l=>{try{const r=new FormData;return l.images.forEach(n=>{r.append("images",n)}),l.titles.forEach(n=>{r.append("titles",n)}),l.descriptions&&l.descriptions.forEach(n=>{r.append("descriptions",n)}),(await E.post(`/work-completion/project/${l.projectId}/images`,r,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(r){throw console.error("Error uploading completion images:",r),r}},re=async l=>{try{return(await E.post("/work-completion",{projectId:l})).data}catch(r){throw console.error("Error creating work completion:",r),r}},te=async l=>{var r;try{const p=await E.get(`/work-completion/project/${l}/certificate`,{responseType:"blob"}),n=window.URL.createObjectURL(new Blob([p.data])),s=document.createElement("a");return s.href=n,s.setAttribute("download",`completion-certificate-${l}.pdf`),document.body.appendChild(s),s.click(),(r=s.parentNode)==null||r.removeChild(s),window.URL.revokeObjectURL(n),p.data}catch(p){throw console.error("Error downloading completion certificate:",p),p}},ae=()=>{var U,Y;const{textTheme:l}=K(),r=B(i=>i.theme.mode),[p,n]=m.useState(!0),[s,u]=m.useState(null),[g,j]=m.useState(null),[w,f]=m.useState(!1),[P,y]=m.useState(!1),[k,M]=m.useState(!1),{projectId:h}=A(),F=H(),t=async()=>{try{n(!0);const i=await $(h);u(i.data)}catch(i){console.error("Error fetching completion data:",i),j("Failed to load completion data")}finally{n(!1)}};m.useEffect(()=>{h||F("/app/dashboard"),t()},[h]);const o=async(i,d,N)=>{var I,S;try{n(!0),await se({projectId:h,images:i,titles:d,descriptions:N});const C=await $(h);u(C.data),b.push(e.jsx(v,{title:"Success",type:"success",children:"Images uploaded successfully"}))}catch(C){console.error("Error uploading images:",C),b.push(e.jsxs(v,{title:"Error",type:"danger",children:["Failed to upload images: ",((S=(I=C.response)==null?void 0:I.data)==null?void 0:S.message)||C.message]}))}finally{n(!1)}},a=async()=>{try{M(!0);const i=await re(h);u(i.data),b.push(e.jsx(v,{title:"Success",type:"success",children:"Work completion created successfully"}))}catch(i){console.error("Error creating work completion:",i),b.push(e.jsx(v,{title:"Error",type:"danger",children:"Failed to create work completion"}))}finally{M(!1)}},c=async()=>{var i;f(!0),j("");try{await te(h),b.push(e.jsx(v,{title:"Success",type:"success",children:"PDF downloaded successfully"}))}catch(d){console.error("Error downloading PDF:",d),j("Failed to download PDF");let N="Failed to download PDF";d.response&&(d.response.status===404?N="Project data not found for PDF generation":d.response.status===400?N="Invalid project data for PDF generation":(i=d.response.data)!=null&&i.message&&(N=d.response.data.message)),b.push(e.jsx(v,{title:"Error",type:"danger",children:N}))}finally{f(!1)}};return g?e.jsxs("div",{className:"p-4 text-center text-red-500",children:[g,e.jsx(x,{className:"mt-4",onClick:()=>window.location.reload(),children:"Retry"})]}):s?e.jsxs(L,{loading:p,children:[e.jsx(ee,{isOpen:P,onClose:()=>y(!1),onUpload:o,projectId:h}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between gap-4 mb-10",children:[e.jsxs("div",{children:[e.jsx(_,{className:"mb-3",mode:r}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"COMPLETION CERTIFICATE"})]}),e.jsxs("div",{className:"my-4",children:[e.jsxs("div",{className:"mb-2",children:[e.jsxs("h4",{children:["Reference: ",s.referenceNumber]}),e.jsx("div",{className:"flex flex-col space-y-1",children:e.jsxs("span",{children:["Prepared On: ",D(s.createdAt).format("dddd, DD MMMM, YYYY")]})})]}),e.jsxs("div",{className:"mt-4 flex",children:[e.jsx(J,{className:`text-xl ${l}`}),e.jsxs("div",{className:"ltr:ml-3 rtl:mr-3",children:["Prepared By: ",(U=s.preparedBy)==null?void 0:U.firstName," ",(Y=s.preparedBy)==null?void 0:Y.lastName]})]}),e.jsxs("div",{className:"mt-4 flex",children:[e.jsx(V,{className:`text-xl ${l}`}),e.jsx("div",{className:"ltr:ml-3 rtl:mr-3",children:e.jsxs("h6",{children:["Project: ",s.project.projectName]})})]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"FM Contractor:"})," ",s.fmContractor]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Sub Contractor:"})," ",s.subContractor]})]}),e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Project Description:"})," ",s.projectDescription]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Location:"})," ",s.location]})]})]}),e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded",children:e.jsx("p",{className:"text-center italic",children:"This is to certify that the work described above on project description has been cleared out and completed."})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[e.jsx("div",{children:e.jsxs("p",{children:[e.jsx("strong",{children:"Completion Date:"})," ",D(s.completionDate).format("DD MMMM, YYYY")]})}),e.jsx("div",{children:e.jsxs("p",{children:[e.jsx("strong",{children:"LPO Number:"})," ",s.lpoNumber]})}),e.jsx("div",{children:e.jsxs("p",{children:[e.jsx("strong",{children:"LPO Date:"})," ",D(s.lpoDate).format("DD MMMM, YYYY")]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8",children:[e.jsxs("div",{className:"border rounded p-4",children:[e.jsx("h5",{className:"font-bold mb-4 text-center",children:"Hand Over By"}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Company:"}),e.jsx("td",{className:"py-2",children:s.handover.company})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Name:"}),e.jsx("td",{className:"py-2",children:s.handover.name})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Date:"}),e.jsx("td",{className:"py-2",children:D(s.handover.date).format("DD MMMM, YYYY")})]})]})})]}),e.jsxs("div",{className:"border rounded p-4",children:[e.jsx("h5",{className:"font-bold mb-4 text-center",children:"Accepted By"}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Company:"}),e.jsx("td",{className:"py-2",children:s.acceptance.company})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Name:"}),e.jsx("td",{className:"py-2",children:s.acceptance.name})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-semibold",children:"Date:"}),e.jsx("td",{className:"py-2",children:D(s.acceptance.date).format("DD MMMM, YYYY")})]})]})})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"font-bold",children:"Site Pictures:"}),e.jsx(x,{variant:"solid",icon:e.jsx(O,{}),onClick:()=>y(!0),children:"Add Images"})]}),s.sitePictures.length>0?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:s.sitePictures.map((i,d)=>e.jsxs("div",{className:"border rounded overflow-hidden",children:[e.jsx("img",{src:i.url,alt:i.caption||`Site Image ${d+1}`,className:"w-full h-48 object-cover"}),i.caption&&e.jsx("div",{className:"p-2 bg-gray-50 dark:bg-gray-700 text-center",children:e.jsx("p",{className:"text-sm",children:i.caption})})]},`image-${d}`))}):e.jsxs("div",{className:"text-center py-8 border rounded bg-gray-50 dark:bg-gray-700",children:[e.jsx("p",{children:"No site pictures uploaded yet"}),e.jsx(x,{className:"mt-4",variant:"solid",icon:e.jsx(O,{}),onClick:()=>y(!0),children:"Upload Images"})]})]}),e.jsxs("div",{className:"print:hidden mt-6 flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"solid",onClick:()=>y(!0),children:"Add More Images"}),e.jsx(x,{variant:"solid",loading:w,onClick:c,children:w?"Generating PDF...":"Download Completion Certificate"})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(L,{loading:k}),e.jsx("p",{className:"mt-4 mb-6",children:"No work completion record found for this project"}),e.jsx(x,{variant:"solid",loading:k,onClick:a,children:"Create Work Completion"})]})},Xe=()=>e.jsx(G,{className:"h-full",children:e.jsx(W,{className:"h-full",bodyClass:"h-full",children:e.jsx(ae,{})})});export{Xe as default};
