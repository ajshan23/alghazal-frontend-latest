import{r as x,a6 as Ae,aj as ke,V as Pe,j as e}from"./index-Cbmuiios.js";import{F as we,a as d}from"./FormItem-Ch1QKVH_.js";import{B as v}from"./Button-CMuxgmp4.js";import{S as qe}from"./StickyFooter-CZAhzGZF.js";import{F as Ce,a as Ne,c as $,b as j}from"./formik.esm-wNH9LbLu.js";import{c as oe,e as Fe,f as z,a as T,g as E}from"./index.esm-DUUudAOL.js";import{t as I,N as O}from"./toast-B9W__RSK.js";import{A as q}from"./AdaptableCard-D1P3b32R.js";import{I as u}from"./Input-CDfEomTD.js";import{Y as U,Z as D}from"./index-CONKTZgq.js";import{S as le}from"./Select-CJl5Fmb_.js";import{g as Te,u as Ie,c as Oe}from"./api-CBVm7Dbj.js";import"./index-CldoBhNp.js";import"./proxy-CYE8-WBg.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BUlPNNq8.js";import"./StatusIcon-BePl3HSs.js";import"./CloseButton-CjMgMnml.js";import"./chainedFunction-BxZSneMW.js";import"./Card-BvQb1NxD.js";import"./Views-Bl2NAvTS.js";import"./isNil-B1IrGwAQ.js";import"./get-DINuEYvC.js";import"./toString-BS2U1RvM.js";import"./floating-ui.dom-D1IisfOw.js";const ce=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],me=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],de=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],Se=oe().shape({validUntil:Fe().required("Valid Until date is required"),scopeOfWork:z().of(T().required("Scope item cannot be empty")).min(1,"At least one scope item is required"),items:z().of(oe().shape({description:T().required("Description is required"),uom:T().required("Unit of measurement is required"),quantity:E().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:E().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:z().of(T().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:E().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),Qe=x.forwardRef((ue,pe)=>{const{onDiscard:ge}=ue,he=Ae(),{projectId:S}=ke(),{state:A}=Pe(),be=A==null?void 0:A.estimationId,g=A==null?void 0:A.quotationId,[fe,ve]=x.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),scopeOfWork:[""],items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:S,estimation:be}),[je,ye]=x.useState(!!g),[C,N]=x.useState([]),[k,Q]=x.useState({});x.useEffect(()=>{(async()=>{if(g)try{const a=await Te(S),s={},y=[];a.items.forEach((r,n)=>{var l;(l=r.image)!=null&&l.url&&(s[n]=r.image.url),y[n]=null}),Q(s),N(y),ve({_id:a._id,quotationNumber:a.quotationNumber,date:new Date(a.date),validUntil:new Date(a.validUntil),scopeOfWork:a.scopeOfWork.length>0?a.scopeOfWork:[""],items:a.items.map(r=>({description:r.description,uom:r.uom,quantity:r.quantity,unitPrice:r.unitPrice,totalPrice:r.totalPrice,image:r.image})),termsAndConditions:a.termsAndConditions.length>0?a.termsAndConditions:[""],vatPercentage:a.vatPercentage,subtotal:a.subtotal,vatAmount:a.vatAmount,netAmount:a.netAmount,project:a.project._id,estimation:a.estimation._id})}catch(a){console.error("Error fetching quotation:",a),I.push(e.jsx(O,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data."}),{placement:"top-center"})}finally{ye(!1)}})()},[g,S]);const xe=async i=>{try{const a=C.filter(s=>s!==null);g?(await Ie(g,{...i,projectId:i.project,estimationId:i.estimation},a),I.push(e.jsx(O,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await Oe({...i,projectId:i.project,estimationId:i.estimation},a),I.push(e.jsx(O,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),he(-1)}catch(a){console.error(`Error ${g?"updating":"creating"} quotation:`,a),I.push(e.jsxs(O,{title:"Error",type:"danger",duration:2500,children:["Failed to ",g?"update":"create"," quotation. Please try again."]}),{placement:"top-center"})}},M=(i,a)=>{const s=[...C];if(s[i]=a,N(s),a&&k[i]){const y={...k};delete y[i],Q(y)}};return je?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(Ce,{innerRef:pe,initialValues:fe,validationSchema:Se,onSubmit:xe,enableReinitialize:!0,children:({values:i,touched:a,errors:s,isSubmitting:y,setFieldValue:r})=>(x.useEffect(()=>{i.items.forEach((t,c)=>{const m=parseFloat((t.quantity*t.unitPrice).toFixed(2));t.totalPrice!==m&&r(`items[${c}].totalPrice`,m)});const n=i.items.reduce((t,c)=>t+c.totalPrice,0);i.subtotal!==n&&r("subtotal",n);const l=parseFloat((n*(i.vatPercentage/100)).toFixed(2)),p=parseFloat((n+l).toFixed(2));i.vatAmount!==l&&r("vatAmount",l),i.netAmount!==p&&r("netAmount",p)},[i.items,i.vatPercentage]),e.jsx(Ne,{children:e.jsxs(we,{children:[e.jsxs(q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Details"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4"})]}),e.jsxs(q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Scope of Work"}),e.jsx($,{name:"scopeOfWork",children:({push:n,remove:l})=>e.jsxs("div",{className:"space-y-4",children:[i.scopeOfWork.map((p,t)=>{var c,m,h;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{className:"flex-grow",invalid:!!((c=s.scopeOfWork)!=null&&c[t])&&((m=a.scopeOfWork)==null?void 0:m[t]),errorMessage:(h=s.scopeOfWork)==null?void 0:h[t],children:e.jsx(j,{as:u,name:`scopeOfWork[${t}]`,placeholder:"Scope of work item"})}),e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>l(t)})]},t)}),e.jsx(v,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(D,{}),onClick:()=>n(""),children:"Add Scope Item"})]})})]}),e.jsxs(q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Items"}),e.jsx($,{name:"items",children:({push:n,remove:l})=>e.jsxs("div",{className:"space-y-4",children:[i.items.map((p,t)=>{var c,m,h,P,F,b,W,V,L,_,B,R,G,H,Y,K,Z,J,X,ee,te,ae,ie,se,re,ne;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-b pb-4",children:[e.jsx(d,{label:`Item ${t+1}`,invalid:!!((m=(c=s.items)==null?void 0:c[t])!=null&&m.description)&&((P=(h=a.items)==null?void 0:h[t])==null?void 0:P.description),errorMessage:(b=(F=s.items)==null?void 0:F[t])==null?void 0:b.description,children:e.jsx(j,{as:u,name:`items[${t}].description`,placeholder:"Description",textArea:!0})}),e.jsx(d,{label:"UOM",invalid:!!((V=(W=s.items)==null?void 0:W[t])!=null&&V.uom)&&((_=(L=a.items)==null?void 0:L[t])==null?void 0:_.uom),errorMessage:(R=(B=s.items)==null?void 0:B[t])==null?void 0:R.uom,children:e.jsx(j,{name:`items[${t}].uom`,children:({field:o,form:f})=>e.jsx(le,{options:ce,value:ce.find(w=>w.value===o.value)||null,onChange:w=>{f.setFieldValue(o.name,(w==null?void 0:w.value)||"")},placeholder:"Select unit"})})}),e.jsx(d,{label:"Qty",invalid:!!((H=(G=s.items)==null?void 0:G[t])!=null&&H.quantity)&&((K=(Y=a.items)==null?void 0:Y[t])==null?void 0:K.quantity),errorMessage:(J=(Z=s.items)==null?void 0:Z[t])==null?void 0:J.quantity,children:e.jsx(j,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:u,min:0,onChange:o=>{const f=parseFloat(o.target.value)||0;r(`items[${t}].quantity`,f)}})}),e.jsx(d,{label:"Unit Price",invalid:!!((ee=(X=s.items)==null?void 0:X[t])!=null&&ee.unitPrice)&&((ae=(te=a.items)==null?void 0:te[t])==null?void 0:ae.unitPrice),errorMessage:(se=(ie=s.items)==null?void 0:ie[t])==null?void 0:se.unitPrice,children:e.jsx(j,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:u,min:0,onChange:o=>{const f=parseFloat(o.target.value)||0;r(`items[${t}].unitPrice`,f)}})}),e.jsx(d,{label:"Total",children:e.jsx(u,{readOnly:!0,value:(p.quantity*p.unitPrice).toFixed(2),placeholder:"Total"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex justify-end",children:i.items.length>1&&e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>{l(t);const o=[...C];if(o.splice(t,1),N(o),k[t]){const f={...k};delete f[t],Q(f)}}})}),e.jsx("input",{type:"file",accept:"image/*",onChange:o=>{o.target.files&&o.target.files[0]?M(t,o.target.files[0]):M(t,null)},className:"text-sm"}),(k[t]||((re=p.image)==null?void 0:re.url))&&e.jsx("div",{className:"mt-1",children:e.jsx("img",{src:k[t]||((ne=p.image)==null?void 0:ne.url),alt:"Item",className:"h-10 w-10 object-cover rounded"})})]})]},t)}),e.jsx(v,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(D,{}),onClick:()=>{n({description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}),N([...C,null])},children:"Add Item"})]})})]}),e.jsxs(q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx($,{name:"termsAndConditions",children:({push:n,remove:l})=>e.jsxs("div",{className:"space-y-4",children:[i.termsAndConditions.map((p,t)=>{var c,m,h;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(d,{className:"flex-grow",invalid:!!((c=s.termsAndConditions)!=null&&c[t])&&((m=a.termsAndConditions)==null?void 0:m[t]),errorMessage:(h=s.termsAndConditions)==null?void 0:h[t],children:t<2?e.jsx(j,{name:`termsAndConditions[${t}]`,children:({field:P,form:F})=>e.jsx(le,{options:t===0?me:de,value:(t===0?me:de).find(b=>b.value===P.value)||null,onChange:b=>{F.setFieldValue(P.name,(b==null?void 0:b.value)||"")},placeholder:t===0?"Select work start term":"Select payment term"})}):e.jsx(j,{as:u,name:`termsAndConditions[${t}]`,placeholder:"Additional term or condition"})}),e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>l(t)})]},t)}),e.jsx(v,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(D,{}),onClick:()=>n(""),children:"Add Term"})]})})]}),e.jsxs(q,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(d,{label:"Subtotal",children:e.jsx(u,{readOnly:!0,value:i.subtotal.toFixed(2),placeholder:"Subtotal"})}),e.jsx(d,{label:"VAT Percentage",invalid:!!s.vatPercentage&&a.vatPercentage,errorMessage:s.vatPercentage,children:e.jsx(j,{as:u,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100})}),e.jsx(d,{label:"VAT Amount",children:e.jsx(u,{readOnly:!0,value:i.vatAmount.toFixed(2),placeholder:"VAT amount"})}),e.jsx(d,{label:"Net Amount",children:e.jsx(u,{readOnly:!0,value:i.netAmount.toFixed(2),placeholder:"Net amount"})})]})]}),e.jsxs(qe,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(v,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ge,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(v,{size:"sm",variant:"solid",loading:y,type:"submit",children:g?"Update Quotation":"Create Quotation"})})]})]})}))})});Qe.displayName="QuotationForm";export{Qe as default};
