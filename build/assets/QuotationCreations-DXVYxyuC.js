import{r as f,v as qe,ak as Ae,X as Pe,j as e}from"./index-D5qsHBPI.js";import{F as we,a as o}from"./FormItem-BjAM8sYA.js";import{B as q}from"./Button-DKlp8XN1.js";import{S as Ce}from"./StickyFooter-D7xjDOAW.js";import{F as Fe,a as ke,b as d,c as ie}from"./formik.esm-XpKb_I1k.js";import{c as re,e as Ne,f as ne,a as U,g as D}from"./index.esm-D0L8hc4Y.js";import{t as N,N as S}from"./toast-BV-KR3on.js";import{A as T}from"./AdaptableCard-UKh7K-Hq.js";import{I as m}from"./Input-DpzrnPB-.js";import{Y as le,Z as se}from"./index-Bjc1-Dfl.js";import{D as Se}from"./index-BO9RL4R9.js";import{S as oe}from"./Select-DCy0le_o.js";import{g as Te,u as Ie,c as Qe}from"./api-oieZMdvL.js";import"./index-CKN0MgBz.js";import"./proxy-QQ9UH2Rr.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-CTX8E6kM.js";import"./StatusIcon-B-JCnJup.js";import"./CloseButton-CYqIcWKK.js";import"./chainedFunction-BxZSneMW.js";import"./Card-yHUwp5an.js";import"./Views-B1b09e4F.js";import"./isNil-BKogIPw7.js";import"./get-BV5slyYd.js";import"./toString-kQNaAZON.js";import"./useControllableState-OCPLuC6T.js";import"./floating-ui.react-CtRk2jQd.js";import"./floating-ui.dom-D1IisfOw.js";import"./Calendar-DWCnCoFE.js";import"./useUniqueId-CheqgfIm.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";const ce=[{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"mg",label:"Milligram (mg)"},{value:"lb",label:"Pound (lb)"},{value:"oz",label:"Ounce (oz)"},{value:"ton",label:"Ton (ton)"},{value:"l",label:"Liter (L)"},{value:"ml",label:"Milliliter (mL)"},{value:"gal",label:"Gallon (gal)"},{value:"pt",label:"Pint (pt)"},{value:"qt",label:"Quart (qt)"},{value:"fl_oz",label:"Fluid Ounce (fl oz)"},{value:"m",label:"Meter (m)"},{value:"cm",label:"Centimeter (cm)"},{value:"mm",label:"Millimeter (mm)"},{value:"in",label:"Inch (in)"},{value:"ft",label:"Foot (ft)"},{value:"yd",label:"Yard (yd)"},{value:"sq_m",label:"Square Meter (m²)"},{value:"sq_cm",label:"Square Centimeter (cm²)"},{value:"sq_mm",label:"Square Millimeter (mm²)"},{value:"sq_km",label:"Square Kilometer (km²)"},{value:"sq_in",label:"Square Inch (in²)"},{value:"sq_ft",label:"Square Foot (ft²)"},{value:"sq_yd",label:"Square Yard (yd²)"},{value:"acre",label:"Acre"},{value:"hectare",label:"Hectare (ha)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"dozen",label:"Dozen (dozen)"},{value:"pack",label:"Pack (pack)"}],me=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],ue=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],Ue=re().shape({validUntil:Ne().required("Valid Until date is required"),items:ne().of(re().shape({description:U().required("Description is required"),uom:U().required("Unit of measurement is required"),quantity:D().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:D().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:ne().of(U().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:D().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),De=f.forwardRef((de,pe)=>{const{onDiscard:ge}=de,be=qe(),{projectId:I}=Ae(),{state:y}=Pe(),he=y==null?void 0:y.estimationId,g=y==null?void 0:y.quotationId,[ve,je]=f.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:I,estimation:he}),[fe,ye]=f.useState(!!g),[C,F]=f.useState([]),[x,Q]=f.useState({});f.useEffect(()=>{(async()=>{if(g)try{const a=await Te(I),r={},j=[];a.items.forEach((n,l)=>{var c;(c=n.image)!=null&&c.url&&(r[l]=n.image.url),j[l]=null}),Q(r),F(j),je({_id:a._id,quotationNumber:a.quotationNumber,date:new Date(a.date),validUntil:new Date(a.validUntil),items:a.items.map(n=>({description:n.description,uom:n.uom,quantity:n.quantity,unitPrice:n.unitPrice,totalPrice:n.totalPrice,image:n.image})),termsAndConditions:a.termsAndConditions.length>0?a.termsAndConditions:[""],vatPercentage:a.vatPercentage,subtotal:a.subtotal,vatAmount:a.vatAmount,netAmount:a.netAmount,project:a.project._id,estimation:a.estimation._id})}catch(a){console.error("Error fetching quotation:",a),N.push(e.jsx(S,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data."}),{placement:"top-center"})}finally{ye(!1)}})()},[g,I]);const xe=async i=>{try{const a=C.filter(r=>r!==null);g?(await Ie(g,{...i,projectId:i.project,estimationId:i.estimation},a),N.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await Qe({...i,projectId:i.project,estimationId:i.estimation},a),N.push(e.jsx(S,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),be(-1)}catch(a){console.error(`Error ${g?"updating":"creating"} quotation:`,a),N.push(e.jsxs(S,{title:"Error",type:"danger",duration:2500,children:["Failed to ",g?"update":"create"," quotation. Please try again."]}),{placement:"top-center"})}},$=(i,a)=>{const r=[...C];if(r[i]=a,F(r),a&&x[i]){const j={...x};delete j[i],Q(j)}};return fe?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(Fe,{innerRef:pe,initialValues:ve,validationSchema:Ue,onSubmit:xe,enableReinitialize:!0,children:({values:i,touched:a,errors:r,isSubmitting:j,setFieldValue:n})=>(f.useEffect(()=>{i.items.forEach((t,p)=>{const b=parseFloat((t.quantity*t.unitPrice).toFixed(2));t.totalPrice!==b&&n(`items[${p}].totalPrice`,b)});const l=i.items.reduce((t,p)=>t+p.totalPrice,0);i.subtotal!==l&&n("subtotal",l);const c=parseFloat((l*(i.vatPercentage/100)).toFixed(2)),u=parseFloat((l+c).toFixed(2));i.vatAmount!==c&&n("vatAmount",c),i.netAmount!==u&&n("netAmount",u)},[i.items,i.vatPercentage]),e.jsx(ke,{children:e.jsxs(we,{children:[e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(o,{label:"Quotation Number",children:e.jsx(d,{name:"quotationNumber",type:"text",readOnly:!0,component:m})}),e.jsx(o,{label:"Date",children:e.jsx(d,{name:"date",type:"date",readOnly:!0,component:m})}),e.jsx(o,{label:"Valid Until *",invalid:!!r.validUntil&&a.validUntil,errorMessage:r.validUntil,children:e.jsx(d,{name:"validUntil",children:({field:l,form:c})=>e.jsx(Se,{placeholder:"Select date",value:l.value,onChange:u=>{c.setFieldValue(l.name,u)}})})})]})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Quotation Items"}),e.jsx(ie,{name:"items",children:({push:l,remove:c})=>e.jsxs("div",{className:"space-y-4",children:[i.items.map((u,t)=>{var p,b,A,P,k,h,z,E,M,O,_,V,L,B,R,H,Y,G,K,X,Z,J,W,ee,te,ae;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-b pb-4",children:[e.jsx(o,{label:`Item ${t+1}`,invalid:!!((b=(p=r.items)==null?void 0:p[t])!=null&&b.description)&&((P=(A=a.items)==null?void 0:A[t])==null?void 0:P.description),errorMessage:(h=(k=r.items)==null?void 0:k[t])==null?void 0:h.description,children:e.jsx(d,{as:m,name:`items[${t}].description`,placeholder:"Description",textArea:!0})}),e.jsx(o,{label:"UOM",invalid:!!((E=(z=r.items)==null?void 0:z[t])!=null&&E.uom)&&((O=(M=a.items)==null?void 0:M[t])==null?void 0:O.uom),errorMessage:(V=(_=r.items)==null?void 0:_[t])==null?void 0:V.uom,children:e.jsx(d,{name:`items[${t}].uom`,children:({field:s,form:v})=>e.jsx(oe,{options:ce,value:ce.find(w=>w.value===s.value)||null,onChange:w=>{v.setFieldValue(s.name,(w==null?void 0:w.value)||"")},placeholder:"Select unit"})})}),e.jsx(o,{label:"Qty",invalid:!!((B=(L=r.items)==null?void 0:L[t])!=null&&B.quantity)&&((H=(R=a.items)==null?void 0:R[t])==null?void 0:H.quantity),errorMessage:(G=(Y=r.items)==null?void 0:Y[t])==null?void 0:G.quantity,children:e.jsx(d,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:m,min:0,step:"any",onChange:s=>{const v=parseFloat(s.target.value)||0;n(`items[${t}].quantity`,v)}})}),e.jsx(o,{label:"Unit Price",invalid:!!((X=(K=r.items)==null?void 0:K[t])!=null&&X.unitPrice)&&((J=(Z=a.items)==null?void 0:Z[t])==null?void 0:J.unitPrice),errorMessage:(ee=(W=r.items)==null?void 0:W[t])==null?void 0:ee.unitPrice,children:e.jsx(d,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:m,min:0,onChange:s=>{const v=parseFloat(s.target.value)||0;n(`items[${t}].unitPrice`,v)}})}),e.jsx(o,{label:"Total",children:e.jsx(m,{readOnly:!0,value:(u.quantity*u.unitPrice).toFixed(2),placeholder:"Total"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex justify-end",children:i.items.length>1&&e.jsx(q,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(le,{}),onClick:()=>{c(t);const s=[...C];if(s.splice(t,1),F(s),x[t]){const v={...x};delete v[t],Q(v)}}})}),e.jsx("input",{type:"file",accept:"image/*",onChange:s=>{s.target.files&&s.target.files[0]?$(t,s.target.files[0]):$(t,null)},className:"text-sm"}),(x[t]||((te=u.image)==null?void 0:te.url))&&e.jsx("div",{className:"mt-1",children:e.jsx("img",{src:x[t]||((ae=u.image)==null?void 0:ae.url),alt:"Item",className:"h-10 w-10 object-cover rounded"})})]})]},t)}),e.jsx(q,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(se,{}),onClick:()=>{l({description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}),F([...C,null])},children:"Add Item"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Terms & Conditions"}),e.jsx(ie,{name:"termsAndConditions",children:({push:l,remove:c})=>e.jsxs("div",{className:"space-y-4",children:[i.termsAndConditions.map((u,t)=>{var p,b,A;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(o,{className:"flex-grow",invalid:!!((p=r.termsAndConditions)!=null&&p[t])&&((b=a.termsAndConditions)==null?void 0:b[t]),errorMessage:(A=r.termsAndConditions)==null?void 0:A[t],children:t<2?e.jsx(d,{name:`termsAndConditions[${t}]`,children:({field:P,form:k})=>e.jsx(oe,{options:t===0?me:ue,value:(t===0?me:ue).find(h=>h.value===P.value)||null,onChange:h=>{k.setFieldValue(P.name,(h==null?void 0:h.value)||"")},placeholder:t===0?"Select work start term":"Select payment term"})}):e.jsx(d,{as:m,name:`termsAndConditions[${t}]`,placeholder:"Additional term or condition"})}),e.jsx(q,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(le,{}),onClick:()=>c(t)})]},t)}),e.jsx(q,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(se,{}),onClick:()=>l(""),children:"Add Term"})]})})]}),e.jsxs(T,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(o,{label:"Subtotal",children:e.jsx(m,{readOnly:!0,value:i.subtotal.toFixed(2),placeholder:"Subtotal"})}),e.jsx(o,{label:"VAT Percentage",invalid:!!r.vatPercentage&&a.vatPercentage,errorMessage:r.vatPercentage,children:e.jsx(d,{as:m,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100})}),e.jsx(o,{label:"VAT Amount",children:e.jsx(m,{readOnly:!0,value:i.vatAmount.toFixed(2),placeholder:"VAT amount"})}),e.jsx(o,{label:"Net Amount",children:e.jsx(m,{readOnly:!0,value:i.netAmount.toFixed(2),placeholder:"Net amount"})})]})]}),e.jsxs(Ce,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(q,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ge,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(q,{size:"sm",variant:"solid",loading:j,type:"submit",children:g?"Update Quotation":"Create Quotation"})})]})]})}))})});De.displayName="QuotationForm";export{De as default};
