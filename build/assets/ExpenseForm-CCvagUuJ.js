import{aj as pe,a6 as xe,r as h,j as e}from"./index-DprkEiEK.js";import{F as ge,a as ue,c as he,b as x}from"./formik.esm-PmOj15rT.js";import{c as k,f as ye,a as y,e as be,g as fe,h as je}from"./index.esm-DuwqUL2u.js";import"./Alert-BkYPvYNz.js";import"./index-Da8XY5ZM.js";import"./Badge-Dt7JCtsY.js";import{B as de}from"./Button-PtpZLnju.js";import"./Calendar-DUSHLq6D.js";import"./Card-BpjZUxOM.js";import"./Skeleton-Ch8Q_reX.js";import{D as Ne}from"./index-DVa3s2tW.js";import"./Dialog-C4kohZQf.js";import"./Drawer-CX6y54ar.js";import"./index-bMq9u0cL.js";import{a as c}from"./FormItem-CLbUnAko.js";import"./useUniqueId-BPFxATym.js";import{I as u}from"./Input-D9aAsaRn.js";import"./index-Cryf1M42.js";import"./index-jGIM7sHo.js";import{t as j,N}from"./toast-6mWVT1dx.js";import"./Progress-Ceind13D.js";import"./index-yA6ev0nJ.js";import"./ScrollBar-BmvQrRag.js";import"./index-DvIR4uCb.js";import"./Select-Bn_1dfRU.js";import"./Upload-DwkkluLb.js";import"./index-CWhs-_CT.js";import"./Tag-CxDnfmc0.js";import"./index-C459fFPL.js";import{Y as ve,Z as ke}from"./index-DRT6ZEuo.js";import{g as we,f as Ee,u as De,c as Se}from"./api-CcTX5uzc.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-BW0HCES2.js";import"./StatusIcon-BF-FCtRa.js";import"./CloseButton-DD9EgaVn.js";import"./proxy-LJQ4uuy1.js";import"./floating-ui.react-svs4PfWS.js";import"./floating-ui.dom-D1IisfOw.js";import"./index-D-ApMVAy.js";import"./useControllableState-BZtcuTBt.js";import"./get-Zx5oz8JG.js";import"./Views-BMPEAoNT.js";import"./toString-Chg3pnU2.js";import"./_getPrototype-ZWmpNt_H.js";import"./index-x0qbPmga.js";import"./index-Chjiymov.js";import"./isNil-DH5bwM4B.js";import"./chainedFunction-BxZSneMW.js";import"./index-Ds5bsVgF.js";const Fe=k().shape({materials:ye().of(k().shape({description:y().required("Description is required"),date:be().required("Date is required"),invoiceNo:y().required("Invoice number is required"),amount:fe().min(0,"Amount must be positive").required("Amount is required"),supplierName:y(),supplierMobile:y(),supplierEmail:y().email("Invalid email format"),file:je().test("fileSize","File too large (max 5MB)",l=>l?l.size<=5*1024*1024:!0).test("fileType","Unsupported file type",l=>l?["application/pdf","image/jpeg","image/png"].includes(l.type):!0)})),laborDetails:k().required("Labor details are required")}),wa=()=>{const{projectId:l,expenseId:g}=pe(),w=xe(),[r,oe]=h.useState(null),[me,E]=h.useState({materials:[{description:"",date:new Date,invoiceNo:"",amount:0,supplierName:"",supplierMobile:"",supplierEmail:"",documentUrl:void 0,documentKey:void 0,file:null}],laborDetails:{workers:[],driver:null,totalLaborCost:0},totalMaterialCost:0}),[ne,D]=h.useState(!0),[S,F]=h.useState(!1);h.useEffect(()=>{(async()=>{try{D(!0);const o=await we(l);if(oe(o.data),g){const s=await Ee(g),i=s.data.materials.map(m=>({...m,date:new Date(m.date),file:null}));E({materials:i,laborDetails:s.data.laborDetails,totalMaterialCost:s.data.totalMaterialCost})}else E(s=>({...s,laborDetails:o.data}))}catch(o){j.push(e.jsx(N,{title:"Error",type:"danger",children:"Failed to load required data"})),console.error("Error fetching data:",o)}finally{D(!1)}})()},[l,g]);const ce=async d=>{var o,s;F(!0);try{const i=new FormData,m=d.materials.map(a=>({description:a.description,date:a.date.toISOString(),invoiceNo:a.invoiceNo,amount:Number(a.amount),supplierName:a.supplierName||void 0,supplierMobile:a.supplierMobile||void 0,supplierEmail:a.supplierEmail||void 0,documentUrl:a.documentUrl,documentKey:a.documentKey}));i.append("materials",JSON.stringify(m)),i.append("laborDetails",JSON.stringify(d.laborDetails)),d.materials.forEach((a,n)=>{if(a.file){const p=new File([a.file],`file-${n}`,{type:a.file.type});i.append("files",p)}}),g?(await De(g,i),j.push(e.jsx(N,{title:"Success",type:"success",children:"Expense updated successfully"}))):(await Se(l,i),j.push(e.jsx(N,{title:"Success",type:"success",children:"Expense created successfully"}))),w(`/projects/${l}/expenses`)}catch(i){const m=((s=(o=i.response)==null?void 0:o.data)==null?void 0:s.message)||i.message||"Failed to process expense";j.push(e.jsx(N,{title:"Error",type:"danger",children:m}),{placement:"top-center"})}finally{F(!1)}};return ne?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 dark:border-blue-400"})}):e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsx(ge,{initialValues:me,validationSchema:Fe,onSubmit:ce,enableReinitialize:!0,children:({values:d,setFieldValue:o,errors:s,touched:i})=>{var m;return e.jsxs(ue,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Material Expenses"}),e.jsx(he,{name:"materials",children:({push:a,remove:n})=>e.jsxs("div",{className:"space-y-4",children:[d.materials.map((p,t)=>{var M,$,I,C,A,q,L,P,T,U,O,R,V,z,B,K,H,J,W,Y,Z,_,G,Q,X,ee,ae,te,re,se,ie,le;return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{label:"Description",invalid:(($=(M=s.materials)==null?void 0:M[t])==null?void 0:$.description)&&((C=(I=i.materials)==null?void 0:I[t])==null?void 0:C.description),errorMessage:(q=(A=s.materials)==null?void 0:A[t])==null?void 0:q.description,children:e.jsx(x,{name:`materials[${t}].description`,as:u,placeholder:"Material description"})}),e.jsx(c,{label:"Date",invalid:((P=(L=s.materials)==null?void 0:L[t])==null?void 0:P.date)&&((U=(T=i.materials)==null?void 0:T[t])==null?void 0:U.date),children:e.jsx(x,{name:`materials[${t}].date`,children:({field:b,form:v})=>e.jsx(Ne,{placeholder:"Select date",value:b.value,onChange:f=>v.setFieldValue(b.name,f)})})}),e.jsx(c,{label:"Invoice Number",invalid:((R=(O=s.materials)==null?void 0:O[t])==null?void 0:R.invoiceNo)&&((z=(V=i.materials)==null?void 0:V[t])==null?void 0:z.invoiceNo),errorMessage:(K=(B=s.materials)==null?void 0:B[t])==null?void 0:K.invoiceNo,children:e.jsx(x,{name:`materials[${t}].invoiceNo`,as:u,placeholder:"Invoice number"})}),e.jsx(c,{label:"Amount (AED)",invalid:((J=(H=s.materials)==null?void 0:H[t])==null?void 0:J.amount)&&((Y=(W=i.materials)==null?void 0:W[t])==null?void 0:Y.amount),errorMessage:(_=(Z=s.materials)==null?void 0:Z[t])==null?void 0:_.amount,children:e.jsx(x,{name:`materials[${t}].amount`,type:"number",as:u,placeholder:"Amount",min:"0",step:"0.01"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsx(c,{label:"Supplier Name",children:e.jsx(x,{name:`materials[${t}].supplierName`,as:u,placeholder:"Supplier name"})}),e.jsx(c,{label:"Supplier Mobile",children:e.jsx(x,{name:`materials[${t}].supplierMobile`,as:u,placeholder:"Supplier mobile"})}),e.jsx(c,{label:"Supplier Email",invalid:((Q=(G=s.materials)==null?void 0:G[t])==null?void 0:Q.supplierEmail)&&((ee=(X=i.materials)==null?void 0:X[t])==null?void 0:ee.supplierEmail),errorMessage:(te=(ae=s.materials)==null?void 0:ae[t])==null?void 0:te.supplierEmail,children:e.jsx(x,{name:`materials[${t}].supplierEmail`,as:u,placeholder:"Supplier email",type:"email"})})]}),e.jsx("div",{className:"mt-4",children:e.jsxs(c,{label:"Document Attachment",invalid:(se=(re=s.materials)==null?void 0:re[t])==null?void 0:se.file,errorMessage:(le=(ie=s.materials)==null?void 0:ie[t])==null?void 0:le.file,children:[e.jsx("input",{type:"file",onChange:b=>{var f;const v=((f=b.target.files)==null?void 0:f[0])||null;o(`materials[${t}].file`,v)},className:`block w-full text-sm text-gray-500\r
                                file:mr-4 file:py-2 file:px-4\r
                                file:rounded-md file:border-0\r
                                file:text-sm file:font-semibold\r
                                file:bg-blue-50 file:text-blue-700\r
                                hover:file:bg-blue-100\r
                                dark:file:bg-blue-900/30 dark:file:text-blue-300\r
                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png"}),p.documentUrl&&!p.file&&e.jsx("div",{className:"mt-2",children:e.jsx("a",{href:p.documentUrl,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300",children:"View Current Document"})}),p.file&&e.jsxs("div",{className:"mt-2 text-sm text-green-600 dark:text-green-400",children:["New file selected: ",p.file.name]})]})}),d.materials.length>1&&e.jsx("div",{className:"flex justify-end mt-4",children:e.jsxs("button",{type:"button",onClick:()=>n(t),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 flex items-center",children:[e.jsx(ve,{className:"mr-1"}),"Remove Item"]})})]},t)}),e.jsxs("button",{type:"button",onClick:()=>a({description:"",date:new Date,invoiceNo:"",amount:0,supplierName:"",supplierMobile:"",supplierEmail:"",file:null}),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none dark:bg-blue-500 dark:hover:bg-blue-600",children:[e.jsx(ke,{className:"mr-1"}),"Add Material"]})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Labor Details"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium mb-3 text-gray-900 dark:text-gray-100",children:"Workers"}),(m=r==null?void 0:r.workers)!=null&&m.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Days Present"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Daily Salary"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Total"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:r.workers.map((a,n)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[a.profileImage&&e.jsx("img",{className:"h-10 w-10 rounded-full mr-3",src:a.profileImage,alt:`${a.firstName} ${a.lastName}`}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:[a.firstName," ",a.lastName]})]})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:a.daysPresent}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:["AED ",a.dailySalary.toFixed(2)]}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400",children:["AED ",a.totalSalary.toFixed(2)]})]},n))})]})}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No workers assigned to this project"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-3 text-gray-900 dark:text-gray-100",children:"Driver"}),r!=null&&r.driver?e.jsxs("div",{className:"flex items-center space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[r.driver.profileImage&&e.jsx("img",{className:"h-12 w-12 rounded-full",src:r.driver.profileImage,alt:`${r.driver.firstName} ${r.driver.lastName}`}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:[r.driver.firstName," ",r.driver.lastName]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Days Present"}),e.jsx("div",{className:"text-gray-900 dark:text-gray-100",children:r.driver.daysPresent})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Daily Salary"}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:["AED ",r.driver.dailySalary.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Total"}),e.jsxs("div",{className:"text-gray-900 dark:text-gray-100",children:["AED ",r.driver.totalSalary.toFixed(2)]})]})]})]})]}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No driver assigned to this project"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Expense Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Material Cost"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100",children:["AED ",d.materials.reduce((a,n)=>a+Number(n.amount),0).toFixed(2)]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Labor Cost"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-gray-900 dark:text-gray-100",children:["AED ",(r==null?void 0:r.totalLaborCost.toFixed(2))||"0.00"]})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 p-4 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400",children:"Total Expense"}),e.jsxs("div",{className:"mt-1 text-2xl font-semibold text-green-600 dark:text-green-400",children:["AED ",(d.materials.reduce((a,n)=>a+Number(n.amount),0)+((r==null?void 0:r.totalLaborCost)||0)).toFixed(2)]})]})]})]}),e.jsxs("div",{className:"sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-3 flex justify-between shadow-lg",children:[e.jsx(de,{type:"button",onClick:()=>w(`/projects/${l}/expenses`),variant:"plain",children:"Cancel"}),e.jsx(de,{type:"submit",variant:"solid",color:"blue-600",loading:S,disabled:S,children:g?"Update Expense":"Create Expense"})]})]})}})})};export{wa as default};
